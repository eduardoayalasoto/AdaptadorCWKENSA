<?xml version="1.0" encoding="UTF-8"?>
<xsl:stylesheet xmlns:exsl="http://exslt.org/common"
  xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:xs="http://www.w3.org/2001/XMLSchema"
  exclude-result-prefixes="xs" version="1.0" extension-element-prefixes="exsl"
  xmlns:w="http://www.cargowise.com/Schemas/Universal/2011/11"
  xmlns:a="http://www.tralix.com/cfd/40">
  <xsl:output method="xml" encoding="UTF-8" indent="yes"/>
  <xsl:key name="ChargeCode" match="//w:PostingJournalCollection/w:PostingJournal"
    use="w:ChargeCode/w:Code"/>
  <xsl:key name="ServicioKey" match="//w:ShipmentCollection/w:Shipment/w:ContainerMode/w:Code"
    use="."/>
  <xsl:key name="MAWBKey"
    match="//w:TransactionInfo/w:ShipmentCollection/w:Shipment/w:WayBillNumber" use="."/>
  <xsl:key name="HAWBKey" match="//w:SubShipmentCollection/w:SubShipment/w:WayBillNumber" use="."/>
  <xsl:key name="uniqueJobs" match="w:PostingJournal/w:Job" use="w:Key"/>
  <xsl:key name="uniqueWayBillNumbers" match="w:Shipment/w:WayBillNumber" use="."/>
  <xsl:key name="uniqueContainers"
    match="//w:SubShipmentCollection/w:SubShipment/w:ContainerCollection/w:Container"
    use="w:ContainerNumber"/>
  <xsl:key name="uniquePackagesCant" match="w:OuterPacks" use="."/>
  <xsl:key name="uniqueWeights" match="w:ManifestedWeight" use="."/>

  <xsl:template match="/">
    <a:Comprobante version="2.0">
      <!--Variables de acondicionamiento-->
      <xsl:variable name="lowercase" select="'abcdefghijklmnopqrstuvwxyz'"/>
      <xsl:variable name="uppercase" select="'ABCDEFGHIJKLMNOPQRSTUVWXYZ'"/>

      <!--Detener facturación en caso de que en descripción manden la palabra NT      -->

      <xsl:variable name="timbrarNC">
        <xsl:choose>
          <xsl:when
            test="//w:PostingJournalCollection/w:PostingJournal[w:ChargeCode/w:Code = 'NCRED']/w:Description">
            <xsl:value-of select="'true'"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:value-of select="'false'"/>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:variable>

      <xsl:if test="//w:TransactionInfo/w:TransactionType = 'CRD' and $timbrarNC = 'false'">
        <xsl:attribute name="NoTimbrarPorNC">
          <xsl:value-of select="'detener'"/>
        </xsl:attribute>
      </xsl:if>

      <!--Variables de Método de Pago y Forma de Pago-->

      <xsl:variable name="Relacionados">
        <xsl:choose>
          <xsl:when
            test="string-length(substring-before(//w:PostingJournalCollection/w:PostingJournal[w:ChargeCode/w:Code = 'REL']/w:Description, '-')) = 2">
            <xsl:value-of select="'true'"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:value-of select="'false'"/>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:variable>

      <xsl:variable name="TipoRelacion">
        <xsl:choose>
          <xsl:when test="$Relacionados = 'true'">
            <xsl:value-of
              select="substring(//w:PostingJournalCollection/w:PostingJournal[w:ChargeCode/w:Code = 'REL']/w:Description, 1, 2)"
            />
          </xsl:when>
          <xsl:otherwise>
            <xsl:value-of select="'01'"/>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:variable>

      <xsl:variable name="uuidRelacionado">
        <xsl:choose>
          <xsl:when test="$Relacionados = 'true'">
            <xsl:value-of
              select="substring-after(//w:PostingJournalCollection/w:PostingJournal[w:ChargeCode/w:Code = 'REL']/w:Description, '-')"
            />
          </xsl:when>
        </xsl:choose>
      </xsl:variable>

      <xsl:variable name="MetodoFormaPagoPath"
        select="//w:OrganizationAddress/w:RegistrationNumberCollection/w:RegistrationNumber[w:Type/w:Code = 'GCR'][w:CountryOfIssue/w:Code = 'MX']/w:Value"/>

      <xsl:variable name="metodoDePago">
        <xsl:choose>
          <xsl:when test="contains($MetodoFormaPagoPath, '-')">
            <xsl:value-of select="substring-before($MetodoFormaPagoPath, '-')"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:value-of select="'PPD'"/>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:variable>

      <xsl:variable name="formaDePago">
        <xsl:choose>

          <xsl:when test="contains($MetodoFormaPagoPath, '-')">
            <xsl:value-of select="substring-after($MetodoFormaPagoPath, '-')"/>
          </xsl:when>

          <xsl:otherwise>
            <xsl:value-of select="'99'"/>
          </xsl:otherwise>

        </xsl:choose>
      </xsl:variable>

      <xsl:variable name="paisCode"
        select="//w:TransactionInfo/w:OrganizationAddress/w:Country/w:Code"/>

      <xsl:variable name="pais">
        <xsl:choose>
          <xsl:when test="$paisCode = 'AD'">
            <xsl:value-of select="'AND'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'AE'">
            <xsl:value-of select="'ARE'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'AF'">
            <xsl:value-of select="'AFG'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'AG'">
            <xsl:value-of select="'ATG'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'AI'">
            <xsl:value-of select="'AIA'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'AL'">
            <xsl:value-of select="'ALB'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'AM'">
            <xsl:value-of select="'ARM'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'AO'">
            <xsl:value-of select="'AGO'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'AQ'">
            <xsl:value-of select="'ATA'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'AR'">
            <xsl:value-of select="'ARG'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'AS'">
            <xsl:value-of select="'ASM'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'AT'">
            <xsl:value-of select="'AUT'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'AU'">
            <xsl:value-of select="'AUS'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'AW'">
            <xsl:value-of select="'ABW'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'AX'">
            <xsl:value-of select="'ALA'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'AZ'">
            <xsl:value-of select="'AZE'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'BA'">
            <xsl:value-of select="'BIH'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'BB'">
            <xsl:value-of select="'BRB'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'BD'">
            <xsl:value-of select="'BGD'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'BE'">
            <xsl:value-of select="'BEL'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'BF'">
            <xsl:value-of select="'BFA'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'BG'">
            <xsl:value-of select="'BGR'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'BH'">
            <xsl:value-of select="'BHR'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'BI'">
            <xsl:value-of select="'BDI'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'BJ'">
            <xsl:value-of select="'BEN'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'BL'">
            <xsl:value-of select="'BLM'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'BM'">
            <xsl:value-of select="'BMU'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'BN'">
            <xsl:value-of select="'BRN'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'BO'">
            <xsl:value-of select="'BOL'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'BQ'">
            <xsl:value-of select="'BES'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'BR'">
            <xsl:value-of select="'BRA'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'BS'">
            <xsl:value-of select="'BHS'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'BT'">
            <xsl:value-of select="'BTN'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'BV'">
            <xsl:value-of select="'BVT'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'BW'">
            <xsl:value-of select="'BWA'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'BY'">
            <xsl:value-of select="'BLR'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'BZ'">
            <xsl:value-of select="'BLZ'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'CA'">
            <xsl:value-of select="'CAN'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'CC'">
            <xsl:value-of select="'CCK'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'CD'">
            <xsl:value-of select="'COD'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'CF'">
            <xsl:value-of select="'CAF'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'CG'">
            <xsl:value-of select="'COG'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'CH'">
            <xsl:value-of select="'CHE'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'CI'">
            <xsl:value-of select="'CIV'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'CK'">
            <xsl:value-of select="'COK'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'CL'">
            <xsl:value-of select="'CHL'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'CM'">
            <xsl:value-of select="'CMR'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'CN'">
            <xsl:value-of select="'CHN'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'CO'">
            <xsl:value-of select="'COL'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'CR'">
            <xsl:value-of select="'CRI'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'CU'">
            <xsl:value-of select="'CUB'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'CV'">
            <xsl:value-of select="'CPV'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'CW'">
            <xsl:value-of select="'CUW'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'CX'">
            <xsl:value-of select="'CXR'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'CY'">
            <xsl:value-of select="'CYP'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'CZ'">
            <xsl:value-of select="'CZE'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'DE'">
            <xsl:value-of select="'DEU'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'DJ'">
            <xsl:value-of select="'DJI'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'DK'">
            <xsl:value-of select="'DNK'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'DM'">
            <xsl:value-of select="'DMA'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'DO'">
            <xsl:value-of select="'DOM'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'DZ'">
            <xsl:value-of select="'DZA'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'EC'">
            <xsl:value-of select="'ECU'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'EE'">
            <xsl:value-of select="'EST'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'EG'">
            <xsl:value-of select="'EGY'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'EH'">
            <xsl:value-of select="'ESH'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'ER'">
            <xsl:value-of select="'ERI'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'ES'">
            <xsl:value-of select="'ESP'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'ET'">
            <xsl:value-of select="'ETH'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'FI'">
            <xsl:value-of select="'FIN'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'FJ'">
            <xsl:value-of select="'FJI'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'FK'">
            <xsl:value-of select="'FLK'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'FM'">
            <xsl:value-of select="'FSM'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'FO'">
            <xsl:value-of select="'FRO'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'FR'">
            <xsl:value-of select="'FRA'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'GA'">
            <xsl:value-of select="'GAB'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'GB'">
            <xsl:value-of select="'GBR'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'GD'">
            <xsl:value-of select="'GRD'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'GE'">
            <xsl:value-of select="'GEO'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'GF'">
            <xsl:value-of select="'GUF'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'GG'">
            <xsl:value-of select="'GGY'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'GH'">
            <xsl:value-of select="'GHA'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'GI'">
            <xsl:value-of select="'GIB'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'GL'">
            <xsl:value-of select="'GRL'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'GM'">
            <xsl:value-of select="'GMB'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'GN'">
            <xsl:value-of select="'GIN'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'GP'">
            <xsl:value-of select="'GLP'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'GQ'">
            <xsl:value-of select="'GNQ'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'GR'">
            <xsl:value-of select="'GRC'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'GS'">
            <xsl:value-of select="'SGS'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'GT'">
            <xsl:value-of select="'GTM'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'GU'">
            <xsl:value-of select="'GUM'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'GW'">
            <xsl:value-of select="'GNB'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'GY'">
            <xsl:value-of select="'GUY'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'HK'">
            <xsl:value-of select="'HKG'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'HM'">
            <xsl:value-of select="'HMD'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'HN'">
            <xsl:value-of select="'HND'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'HR'">
            <xsl:value-of select="'HRV'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'HT'">
            <xsl:value-of select="'HTI'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'HU'">
            <xsl:value-of select="'HUN'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'ID'">
            <xsl:value-of select="'IDN'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'IE'">
            <xsl:value-of select="'IRL'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'IL'">
            <xsl:value-of select="'ISR'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'IM'">
            <xsl:value-of select="'IMN'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'IN'">
            <xsl:value-of select="'IND'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'IO'">
            <xsl:value-of select="'IOT'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'IQ'">
            <xsl:value-of select="'IRQ'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'IR'">
            <xsl:value-of select="'IRN'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'IS'">
            <xsl:value-of select="'ISL'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'IT'">
            <xsl:value-of select="'ITA'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'JE'">
            <xsl:value-of select="'JEY'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'JM'">
            <xsl:value-of select="'JAM'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'JO'">
            <xsl:value-of select="'JOR'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'JP'">
            <xsl:value-of select="'JPN'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'KE'">
            <xsl:value-of select="'KEN'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'KG'">
            <xsl:value-of select="'KGZ'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'KH'">
            <xsl:value-of select="'KHM'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'KI'">
            <xsl:value-of select="'KIR'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'KM'">
            <xsl:value-of select="'COM'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'KN'">
            <xsl:value-of select="'KNA'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'KP'">
            <xsl:value-of select="'PRK'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'KR'">
            <xsl:value-of select="'KOR'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'KW'">
            <xsl:value-of select="'KWT'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'KY'">
            <xsl:value-of select="'CYM'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'KZ'">
            <xsl:value-of select="'KAZ'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'LA'">
            <xsl:value-of select="'LAO'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'LB'">
            <xsl:value-of select="'LBN'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'LC'">
            <xsl:value-of select="'LCA'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'LI'">
            <xsl:value-of select="'LIE'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'LK'">
            <xsl:value-of select="'LKA'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'LR'">
            <xsl:value-of select="'LBR'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'LS'">
            <xsl:value-of select="'LSO'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'LT'">
            <xsl:value-of select="'LTU'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'LU'">
            <xsl:value-of select="'LUX'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'LV'">
            <xsl:value-of select="'LVA'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'LY'">
            <xsl:value-of select="'LBY'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'MA'">
            <xsl:value-of select="'MAR'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'MC'">
            <xsl:value-of select="'MCO'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'MD'">
            <xsl:value-of select="'MDA'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'ME'">
            <xsl:value-of select="'MNE'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'MF'">
            <xsl:value-of select="'MAF'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'MG'">
            <xsl:value-of select="'MDG'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'MH'">
            <xsl:value-of select="'MHL'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'MK'">
            <xsl:value-of select="'MKD'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'ML'">
            <xsl:value-of select="'MLI'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'MM'">
            <xsl:value-of select="'MMR'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'MN'">
            <xsl:value-of select="'MNG'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'MO'">
            <xsl:value-of select="'MAC'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'MP'">
            <xsl:value-of select="'MNP'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'MQ'">
            <xsl:value-of select="'MTQ'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'MR'">
            <xsl:value-of select="'MRT'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'MS'">
            <xsl:value-of select="'MSR'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'MT'">
            <xsl:value-of select="'MLT'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'MU'">
            <xsl:value-of select="'MUS'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'MV'">
            <xsl:value-of select="'MDV'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'MW'">
            <xsl:value-of select="'MWI'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'MX'">
            <xsl:value-of select="'MEX'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'MY'">
            <xsl:value-of select="'MYS'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'MZ'">
            <xsl:value-of select="'MOZ'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'NA'">
            <xsl:value-of select="'NAM'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'NC'">
            <xsl:value-of select="'NCL'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'NE'">
            <xsl:value-of select="'NER'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'NF'">
            <xsl:value-of select="'NFK'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'NG'">
            <xsl:value-of select="'NGA'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'NI'">
            <xsl:value-of select="'NIC'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'NL'">
            <xsl:value-of select="'NLD'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'NO'">
            <xsl:value-of select="'NOR'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'NP'">
            <xsl:value-of select="'NPL'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'NR'">
            <xsl:value-of select="'NRU'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'NU'">
            <xsl:value-of select="'NIU'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'NZ'">
            <xsl:value-of select="'NZL'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'OM'">
            <xsl:value-of select="'OMN'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'PA'">
            <xsl:value-of select="'PAN'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'PE'">
            <xsl:value-of select="'PER'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'PF'">
            <xsl:value-of select="'PYF'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'PG'">
            <xsl:value-of select="'PNG'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'PH'">
            <xsl:value-of select="'PHL'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'PK'">
            <xsl:value-of select="'PAK'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'PL'">
            <xsl:value-of select="'POL'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'PM'">
            <xsl:value-of select="'SPM'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'PN'">
            <xsl:value-of select="'PCN'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'PR'">
            <xsl:value-of select="'PRI'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'PS'">
            <xsl:value-of select="'PSE'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'PT'">
            <xsl:value-of select="'PRT'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'PW'">
            <xsl:value-of select="'PLW'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'PY'">
            <xsl:value-of select="'PRY'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'QA'">
            <xsl:value-of select="'QAT'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'RE'">
            <xsl:value-of select="'REU'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'RO'">
            <xsl:value-of select="'ROU'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'RS'">
            <xsl:value-of select="'SRB'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'RU'">
            <xsl:value-of select="'RUS'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'RW'">
            <xsl:value-of select="'RWA'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'SA'">
            <xsl:value-of select="'SAU'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'SB'">
            <xsl:value-of select="'SLB'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'SC'">
            <xsl:value-of select="'SYC'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'SD'">
            <xsl:value-of select="'SDN'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'SE'">
            <xsl:value-of select="'SWE'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'SG'">
            <xsl:value-of select="'SGP'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'SH'">
            <xsl:value-of select="'SHN'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'SI'">
            <xsl:value-of select="'SVN'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'SJ'">
            <xsl:value-of select="'SJM'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'SK'">
            <xsl:value-of select="'SVK'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'SL'">
            <xsl:value-of select="'SLE'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'SM'">
            <xsl:value-of select="'SMR'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'SN'">
            <xsl:value-of select="'SEN'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'SO'">
            <xsl:value-of select="'SOM'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'SR'">
            <xsl:value-of select="'SUR'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'SS'">
            <xsl:value-of select="'SSD'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'ST'">
            <xsl:value-of select="'STP'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'SV'">
            <xsl:value-of select="'SLV'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'SX'">
            <xsl:value-of select="'SXM'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'SY'">
            <xsl:value-of select="'SYR'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'SZ'">
            <xsl:value-of select="'SWZ'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'TC'">
            <xsl:value-of select="'TCA'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'TD'">
            <xsl:value-of select="'TCD'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'TF'">
            <xsl:value-of select="'ATF'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'TG'">
            <xsl:value-of select="'TGO'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'TH'">
            <xsl:value-of select="'THA'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'TJ'">
            <xsl:value-of select="'TJK'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'TK'">
            <xsl:value-of select="'TKL'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'TL'">
            <xsl:value-of select="'TLS'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'TM'">
            <xsl:value-of select="'TKM'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'TN'">
            <xsl:value-of select="'TUN'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'TO'">
            <xsl:value-of select="'TON'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'TR'">
            <xsl:value-of select="'TUR'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'TT'">
            <xsl:value-of select="'TTO'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'TV'">
            <xsl:value-of select="'TUV'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'TW'">
            <xsl:value-of select="'TWN'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'TZ'">
            <xsl:value-of select="'TZA'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'UA'">
            <xsl:value-of select="'UKR'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'UG'">
            <xsl:value-of select="'UGA'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'UM'">
            <xsl:value-of select="'UMI'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'US'">
            <xsl:value-of select="'USA'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'UY'">
            <xsl:value-of select="'URY'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'UZ'">
            <xsl:value-of select="'UZB'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'VA'">
            <xsl:value-of select="'VAT'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'VC'">
            <xsl:value-of select="'VCT'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'VE'">
            <xsl:value-of select="'VEN'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'VG'">
            <xsl:value-of select="'VGB'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'VI'">
            <xsl:value-of select="'VIR'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'VN'">
            <xsl:value-of select="'VNM'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'VU'">
            <xsl:value-of select="'VUT'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'WF'">
            <xsl:value-of select="'WLF'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'WS'">
            <xsl:value-of select="'WSM'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'XK'">
            <xsl:value-of select="'XKX'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'YE'">
            <xsl:value-of select="'YEM'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'YT'">
            <xsl:value-of select="'MYT'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'ZA'">
            <xsl:value-of select="'ZAF'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'ZM'">
            <xsl:value-of select="'ZMB'"/>
          </xsl:when>
          <xsl:when test="$paisCode = 'ZW'">
            <xsl:value-of select="'ZWE'"/>
          </xsl:when>

        </xsl:choose>
      </xsl:variable>

      <xsl:variable name="rfc">
        <xsl:choose>
          <xsl:when test="$pais = 'MEX'">
            <xsl:value-of
              select="translate(//w:OrganizationAddress/w:RegistrationNumberCollection/w:RegistrationNumber[w:Type/w:Code = 'RFC'][w:CountryOfIssue/w:Code = 'MX']/w:Value, ' -', '')"
            />
          </xsl:when>
          <xsl:when test="not($pais = 'MEX')">
            <xsl:value-of select="'XEXX010101000'"/>
          </xsl:when>
        </xsl:choose>
      </xsl:variable>

      <xsl:variable name="RegimenFiscalReceptor">
        <xsl:choose>
          <xsl:when test="$pais = 'MEX'">
            <xsl:value-of
              select="//w:OrganizationAddress/w:RegistrationNumberCollection/w:RegistrationNumber[w:Type/w:Code = 'GBR'][w:CountryOfIssue/w:Code = 'MX']/w:Value"
            />
          </xsl:when>
          <xsl:when test="not($pais = 'MEX')">
            <xsl:value-of select="'616'"/>
          </xsl:when>
        </xsl:choose>
      </xsl:variable>

      <xsl:variable name="Relacionados">
        <xsl:choose>
          <xsl:when
            test="string-length(substring-before(//w:PostingJournalCollection/w:PostingJournal[w:ChargeCode/w:Code = 'REL']/w:Description, '-')) = 2">
            <xsl:value-of select="'true'"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:value-of select="'false'"/>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:variable>

      <xsl:variable name="TipoRelacion">
        <xsl:choose>
          <xsl:when test="$Relacionados = 'true'">
            <xsl:value-of
              select="substring(//w:PostingJournalCollection/w:PostingJournal[w:ChargeCode/w:Code = 'REL']/w:Description, 1, 2)"
            />
          </xsl:when>
          <xsl:otherwise>
            <xsl:value-of select="'01'"/>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:variable>

      <xsl:variable name="uuidRelacionado">
        <xsl:choose>
          <xsl:when test="$Relacionados = 'true'">
            <xsl:value-of
              select="substring-after(//w:PostingJournalCollection/w:PostingJournal[w:ChargeCode/w:Code = 'REL']/w:Description, '-')"
            />
          </xsl:when>
        </xsl:choose>
      </xsl:variable>

      <!--Variable para crear condicionesDePago-->
      <xsl:choose>
        <xsl:when test="//w:TransactionInfo/w:InvoiceTerm = 'COD'">
          <xsl:variable name="condiciones" select="//w:TransactionInfo/w:InvoiceTerm"/>
          <xsl:variable name="dias" select="//w:TransactionInfo/w:InvoiceTermDays"/>
          <xsl:attribute name="condicionesDePago">
            <xsl:value-of select="concat($condiciones, ' - ', $dias, ' DAYS')"/>
          </xsl:attribute>
        </xsl:when>
      </xsl:choose>

      <xsl:attribute name="cantidadLetra">
        <xsl:value-of select="'-'"/>
      </xsl:attribute>

      <xsl:if test="//w:TransactionInfo/w:DueDate">
        <xsl:attribute name="fechaVencimiento">
          <xsl:value-of select="substring-before(//w:TransactionInfo/w:DueDate, 'T')"/>
        </xsl:attribute>
      </xsl:if>

      <!--Fecha-->
      <xsl:variable name="fechaemision">
        <xsl:choose>
          <xsl:when test="contains(//w:TransactionInfo/w:DataContext/w:TriggerDate, '.')">
            <xsl:value-of
              select="substring-before(substring-before(//w:TransactionInfo/w:DataContext/w:TriggerDate, '.'), 'T')"
            />
          </xsl:when>
          <xsl:otherwise>
            <xsl:value-of
              select="substring-before(//w:TransactionInfo/w:DataContext/w:TriggerDate, 'T')"/>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:variable>

      <!-- Serie y Folio -->
      <xsl:variable name="serie">
        <xsl:choose>
          <xsl:when test="//w:TransactionInfo/w:TransactionType = 'INV'">

            <xsl:value-of select="'B'"/>

          </xsl:when>
          <xsl:when test="//w:TransactionInfo/w:TransactionType = 'CRD'">

            <xsl:value-of select="'NC'"/>

          </xsl:when>
        </xsl:choose>
      </xsl:variable>
      <xsl:variable name="folio">
        <xsl:choose>
          <xsl:when test="contains(//w:TransactionInfo/w:TransactionReference, 'B')">
            <xsl:value-of
              select="number(translate(//w:TransactionInfo/w:TransactionReference, 'B', ''))"/>
          </xsl:when>
          <xsl:when test="contains(//w:TransactionInfo/w:TransactionType, 'CRD')">
            <xsl:value-of select="number(//w:TransactionInfo/w:Number)"/>
          </xsl:when>
        </xsl:choose>
      </xsl:variable>
      <xsl:attribute name="serie">
        <xsl:value-of select="$serie"/>
      </xsl:attribute>
      <xsl:attribute name="folio">
        <xsl:value-of select="$folio"/>

      </xsl:attribute>

      <!-- Leer tipo de documento para desplegar tipo de documento -->
      <xsl:variable name="tipoDeComprobante">
        <xsl:choose>
          <xsl:when test="//w:TransactionInfo/w:TransactionType = 'INV'">
            <xsl:value-of select="'I'"/>
          </xsl:when>
          <xsl:when test="//w:TransactionInfo/w:TransactionType = 'CRD'">
            <xsl:value-of select="'E'"/>
          </xsl:when>
        </xsl:choose>
      </xsl:variable>
      <xsl:attribute name="tipoDeComprobante">
        <xsl:value-of select="$tipoDeComprobante"/>
      </xsl:attribute>

      <!-- Variables de Moneda y Tipo de Cambio -->
      <xsl:variable name="Moneda" select="//w:TransactionInfo/w:OSCurrency/w:Code"/>
      <xsl:attribute name="Moneda">
        <xsl:value-of select="$Moneda"/>
      </xsl:attribute>
      <xsl:variable name="TipoCambio">
        <xsl:choose>
          <xsl:when test="$Moneda = 'MXN'">
            <xsl:value-of select="'1'"/>
          </xsl:when>
          <xsl:when test="$Moneda != 'MXN'">
            <xsl:value-of
              select="format-number(number(//w:TransactionInfo/w:ExchangeRate), '0.0000')"/>
          </xsl:when>
        </xsl:choose>
      </xsl:variable>
      <xsl:attribute name="TipoCambio">
        <xsl:value-of select="$TipoCambio"/>
      </xsl:attribute>

      <!-- 
        Se suman todos los conceptos donde el charge code no sea DTA ni PREVAL = subtotal
      -->
      <xsl:variable name="pathConcepto"
        select="//w:PostingJournalCollection/w:PostingJournal/w:OSAmount"/>

      <xsl:variable name="pathIva"
        select="//w:PostingJournalCollection/w:PostingJournal/w:OSGSTVATAmount"/>

      <xsl:variable name="pathIvaRet">
        <xsl:choose>
          <xsl:when
            test="//w:PostingJournalCollection/w:PostingJournal[w:GLAccount/w:AccountCode = '425.01.000']/w:OSExtraVATAmount">
            <xsl:value-of
              select="//w:PostingJournalCollection/w:PostingJournal[w:GLAccount/w:AccountCode = '425.01.000']/w:OSExtraVATAmount"
            />
          </xsl:when>
          <xsl:otherwise>
            <xsl:value-of
              select="//w:PostingJournalCollection/w:PostingJournal[w:ChargeCode/w:Code != 'CMT' and w:ChargeCode/w:Code != 'DTA' and w:ChargeCode/w:Code != 'PREVAL']/w:OSExtraVATAmount"
            />
          </xsl:otherwise>
        </xsl:choose>
      </xsl:variable>

      <xsl:variable name="subtotal">
        <xsl:value-of select="sum($pathConcepto[. &gt; 0]) - sum($pathConcepto[. &lt; 0])"/>
      </xsl:variable>

      <xsl:variable name="descuento">
        <xsl:choose>
          <xsl:when test="$tipoDeComprobante = 'E'">
            <xsl:value-of select="0"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:value-of select="sum($pathConcepto[. &lt; 0]) * -1"/>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:variable>

      <xsl:variable name="IVA">
        <xsl:value-of select="sum($pathIva[. &gt; 0]) - sum($pathIva[. &lt; 0])"/>
      </xsl:variable>

      <xsl:variable name="IVARetenidoSuma">
        <xsl:value-of select="sum($pathIvaRet[. &gt; 0]) - sum($pathIvaRet[. &lt; 0])"/>
      </xsl:variable>

      <xsl:variable name="IVASuma">
        <xsl:value-of select="format-number($IVA + $IVARetenidoSuma, '0.00')"/>
      </xsl:variable>

      <xsl:variable name="IVAcero">
        <xsl:value-of
          select="count(//w:PostingJournalCollection/w:PostingJournal[w:ChargeCode/w:Code != 'CMT' and w:ChargeCode/w:Code != 'DTA' and w:ChargeCode/w:Code != 'PREVAL']/w:VATTaxID[w:TaxCode = 'FREEIVA'])"
        />
      </xsl:variable>

      <xsl:variable name="total" select="$subtotal + $IVASuma - $IVARetenidoSuma - $descuento"/>

      <xsl:if test="$descuento &gt; 0 and $tipoDeComprobante = 'I'">
        <xsl:attribute name="descuento">
          <xsl:value-of select="format-number($descuento, '0.00')"/>
        </xsl:attribute>
      </xsl:if>

      <xsl:attribute name="subTotal">
        <xsl:value-of select="format-number($subtotal, '0.00')"/>
      </xsl:attribute>

      <xsl:variable name="subTotal2" select="format-number($subtotal, '0.00')"/>

      <xsl:attribute name="total">
        <xsl:value-of select="format-number($total, '0.00')"/>
      </xsl:attribute>

      <xsl:attribute name="LugarExpedicion">
        <xsl:value-of select="11560"/>
      </xsl:attribute>

      <xsl:attribute name="fecha">
        <xsl:choose>
          <xsl:when test="contains(//w:TransactionInfo/w:DataContext/w:TriggerDate, '.')">
            <xsl:value-of
              select="substring-before(//w:TransactionInfo/w:DataContext/w:TriggerDate, '.')"/>
          </xsl:when>
          <xsl:otherwise>
            <xsl:value-of select="//w:TransactionInfo/w:DataContext/w:TriggerDate"/>
          </xsl:otherwise>
        </xsl:choose>
      </xsl:attribute>

      <xsl:attribute name="metodoDePago">
        <xsl:value-of select="$metodoDePago"/>
      </xsl:attribute>

      <xsl:attribute name="formaDePago">
        <xsl:value-of select="$formaDePago"/>
      </xsl:attribute>

      <xsl:attribute name="Exportacion">
        <xsl:value-of select="'01'"/>
      </xsl:attribute>

      <!-- Nodo Comprobante relacionados  -->
      <xsl:if
        test="$TipoRelacion and $Relacionados = 'true' and //w:PostingJournalCollection/w:PostingJournal[w:ChargeCode/w:Code = 'REL']/w:Description">
        <CfdiRelacionados>
          <xsl:attribute name="TipoRelacion">
            <xsl:value-of select="$TipoRelacion"/>
          </xsl:attribute>
          <xsl:for-each
            select="//w:PostingJournalCollection/w:PostingJournal[w:ChargeCode/w:Code = 'REL']/w:Description">
            <xsl:variable name="uuidRelacionado" select="substring-after(., '-')"/>
            <CfdiRelacionado>
              <xsl:attribute name="UUID">
                <xsl:value-of select="$uuidRelacionado"/>
              </xsl:attribute>
            </CfdiRelacionado>
          </xsl:for-each>
        </CfdiRelacionados>
      </xsl:if>

      <!-- Nodo Receptor  -->
      <Receptor>
        <!--        <xsl:if test="//w:TransactionInfo/w:OrganizationAddress/w:OrganizationCode = 'HEPDETBOD'">
          <xsl:attribute name="DetenerPorCliente">
            <xsl:value-of select="'HEPDETBOD'"/>
          </xsl:attribute>
        </xsl:if>-->

        <xsl:variable name="NumRegIdTrib">
          <xsl:choose>
            <xsl:when
              test="//w:RegistrationNumberCollection/w:RegistrationNumber[w:CountryOfIssue/w:Code = $paisCode]/w:Value">
              <xsl:value-of
                select="translate(//w:RegistrationNumberCollection/w:RegistrationNumber[w:CountryOfIssue/w:Code = $paisCode]/w:Value, '- ', '')"
              />
            </xsl:when>
            <xsl:otherwise>
              <xsl:value-of select="'000000000'"/>
            </xsl:otherwise>
          </xsl:choose>
        </xsl:variable>

        <xsl:variable name="ResidenciaFiscal">
          <xsl:value-of select="$pais"/>
        </xsl:variable>

        <xsl:attribute name="rfc">
          <xsl:value-of select="$rfc"/>
        </xsl:attribute>

        <!--translate nombre!-->
        <xsl:variable name="transformNombre"
          select="translate(//w:TransactionInfo/w:OrganizationAddress/w:CompanyName, 'abcdefghijklmnñopqrstuvwxyzáéíóú', 'ABCDEFGHIJKLMNÑOPQRSTUVWXYZÁÉÍÓÚ')"/>

        <xsl:variable name="transformNombre"
          select="translate(normalize-space($transformNombre), 'ÁÉÍÓÚ', 'AEIOU')"/>

        <xsl:variable name="transformNombre">
          <xsl:choose>
            <xsl:when test="$pais != 'MEX'">
              <xsl:value-of select="$transformNombre"/>
            </xsl:when>
            <xsl:when test="contains($transformNombre, ' SA DE CV')">
              <xsl:value-of select="substring-before($transformNombre, ' SA DE CV')"/>
            </xsl:when>
            <xsl:when test="contains($transformNombre, ' SA DE CV A EN P')">
              <xsl:value-of select="substring-before($transformNombre, ' SA DE CV A EN P')"/>
            </xsl:when>
            <xsl:when test="contains($transformNombre, ' SDE RLDE CV')">
              <xsl:value-of select="substring-before($transformNombre, ' SDE RLDE CV')"/>
            </xsl:when>
            <xsl:when test="contains($transformNombre, ' S DE RL DE CV Y/O SRL DE CV')">
              <xsl:value-of
                select="substring-before($transformNombre, ' S DE RL DE CV Y/O SRL DE CV')"/>
            </xsl:when>
            <xsl:when test="contains($transformNombre, 'S DE RL DE CV')">
              <xsl:value-of select="substring-before($transformNombre, ' S DE RL DE CV')"/>
            </xsl:when>
            <xsl:when test="contains($transformNombre, 'SAPI DE CV')">
              <xsl:value-of select="substring-before($transformNombre, ' SAPI DE CV')"/>
            </xsl:when>
            <xsl:when test="contains($transformNombre, 'SPR DE RL')">
              <xsl:value-of select="substring-before($transformNombre, ' SPR DE RL')"/>
            </xsl:when>
            <xsl:when test="contains($transformNombre, ' SC')">
              <xsl:value-of select="substring-before($transformNombre, ' SC')"/>
            </xsl:when>
            <xsl:when test="contains($transformNombre, ' S C')">
              <xsl:value-of select="substring-before($transformNombre, ' S C')"/>
            </xsl:when>
            <xsl:when test="contains($transformNombre, ' AC')">
              <xsl:value-of select="substring-before($transformNombre, ' AC')"/>
            </xsl:when>
            <xsl:when test="contains($transformNombre, 'SAS DE CV')">
              <xsl:value-of select="substring-before($transformNombre, ' SAS DE CV')"/>
            </xsl:when>
            <xsl:when test="contains($transformNombre, ' SA')">
              <xsl:value-of select="substring-before($transformNombre, ' SA')"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:value-of select="$transformNombre"/>
            </xsl:otherwise>
          </xsl:choose>
        </xsl:variable>
        <!--translate-->

        <xsl:variable name="transformNombre">
          <xsl:choose>
            <xsl:when test="$rfc = 'AAF920730F81'">
              <xsl:value-of select="'AAACESA, ALMACENES FISCALIZADOS, S.A. DE C.V.'"/>
            </xsl:when>
            <xsl:when test="$rfc = 'TCA000418IV2'">
              <xsl:value-of select="'TAMPA CARGO SA S'"/>
            </xsl:when>
            <xsl:when test="$rfc = 'CEI230825BBA'">
              <xsl:value-of select="'CREATIO ESPACIOS INTELIGENTES MEXICO'"/>
            </xsl:when>
            <xsl:when test="$rfc = 'SARH5910272R0'">
              <xsl:value-of select="'HECTOR SALAS RUIZ'"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:value-of select="$transformNombre"/>
            </xsl:otherwise>
          </xsl:choose>
        </xsl:variable>

        <xsl:attribute name="Nombre">
          <xsl:value-of select="$transformNombre"/>
        </xsl:attribute>

        <xsl:if test="//w:TransactionInfo/w:OrganizationAddress/w:OrganizationCode">
          <xsl:attribute name="identificador">
            <xsl:value-of select="//w:TransactionInfo/w:OrganizationAddress/w:OrganizationCode"/>
          </xsl:attribute>
        </xsl:if>

        <xsl:attribute name="UsoCFDI">
          <xsl:choose>
            <xsl:when test="$pais = 'MEX' and $tipoDeComprobante = 'I'">
              <xsl:value-of
                select="//w:OrganizationAddress/w:RegistrationNumberCollection/w:RegistrationNumber[w:Type/w:Code = 'CFD'][w:CountryOfIssue/w:Code = 'MX']/w:Value"
              />
            </xsl:when>
            <xsl:when test="$pais = 'MEX' and $tipoDeComprobante = 'E'">
              <xsl:value-of select="'G02'"/>
            </xsl:when>
            <xsl:when test="$pais != 'MEX'">
              <xsl:value-of select="'S01'"/>
            </xsl:when>
          </xsl:choose>
        </xsl:attribute>

        <xsl:attribute name="RegimenFiscalReceptor">
          <xsl:value-of select="$RegimenFiscalReceptor"/>
        </xsl:attribute>

        <xsl:attribute name="DomicilioFiscalReceptor">
          <xsl:choose>
            <xsl:when test="$pais = 'MEX' and $rfc != 'XAXX010101000'">
              <xsl:value-of select="//w:TransactionInfo/w:OrganizationAddress/w:Postcode"/>
            </xsl:when>


            <xsl:when test="$rfc = 'XEXX010101000'">
              <xsl:value-of select="11560"/>
            </xsl:when>
          </xsl:choose>
        </xsl:attribute>

        <Domicilio>
          <xsl:if test="//w:TransactionInfo/w:OrganizationAddress/w:Address1">
            <xsl:attribute name="calle">
              <xsl:value-of
                select="concat(//w:TransactionInfo/w:OrganizationAddress/w:Address1, ' ', //w:TransactionInfo/w:OrganizationAddress/w:Address2)"
              />
            </xsl:attribute>
          </xsl:if>
          <xsl:if test="//w:TransactionInfo/w:OrganizationAddress/w:Postcode">
            <xsl:attribute name="codigoPostal">
              <xsl:value-of select="//w:TransactionInfo/w:OrganizationAddress/w:Postcode"/>
            </xsl:attribute>
          </xsl:if>

          <xsl:if test="//w:TransactionInfo/w:OrganizationAddress/w:State != ''">
            <xsl:attribute name="estado">
              <xsl:value-of select="//w:TransactionInfo/w:OrganizationAddress/w:State"/>
            </xsl:attribute>
          </xsl:if>

          <xsl:if test="//w:TransactionInfo/w:OrganizationAddress/w:City">
            <xsl:attribute name="municipio">
              <xsl:value-of select="//w:TransactionInfo/w:OrganizationAddress/w:City"/>
            </xsl:attribute>
          </xsl:if>

          <xsl:attribute name="pais">
            <xsl:value-of select="$pais"/>
          </xsl:attribute>
        </Domicilio>

        <EnvioEmail>
          <xsl:variable name="operadorName">
            <xsl:value-of select="//w:TransactionInfo/w:DataContext/w:EventUser/w:Name"/>
          </xsl:variable>
          <xsl:variable name="operadorCode">
            <xsl:value-of select="//w:TransactionInfo/w:DataContext/w:EventUser/w:Code"/>
          </xsl:variable>
          <xsl:variable name="Shipment" select="//w:Job/w:Key"/>

          <!-- Email segun operadores  -->
          <xsl:variable name="correo">
            <xsl:choose>
              <xsl:when test="$operadorCode = 'AJ'">
                <xsl:value-of select="'mx.ajimenez@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'AMR'">
                <xsl:value-of select="'mx.amartinez@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'IZ'">
                <xsl:value-of select="'mx.iramirez@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'EV'">
                <xsl:value-of select="'mx.evargas@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'JRE'">
                <xsl:value-of select="'mx.jreyes@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'MV'">
                <xsl:value-of select="'mx.mvega@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'OCE'">
                <xsl:value-of select="'mx.ocervantes@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'OC'">
                <xsl:value-of select="'mx.ogonzalez@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'ZP'">
                <xsl:value-of select="'mx.zpedraza@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'SL'">
                <xsl:value-of select="'mx.slopez@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'JM'">
                <xsl:value-of select="'mx.jmellado@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'JG'">
                <xsl:value-of select="'mx.jguillen@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'JL'">
                <xsl:value-of select="'mx.jcluis@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'MJF'">
                <xsl:value-of select="'mx.mjflores@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'VA'">
                <xsl:value-of select="'mx.varroyo@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'NE'">
                <xsl:value-of select="'mx.nescobar@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'VG'">
                <xsl:value-of select="'mx.vgonzalez@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'MS'">
                <xsl:value-of select="'mx.msantos@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'ATU'">
                <xsl:value-of select="'mx.aaceves@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'LGC'">
                <xsl:value-of select="'mx.lguerrero@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'YZ'">
                <xsl:value-of select="'mx.yvazquez@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'CV'">
                <xsl:value-of select="'mx.cvalenzuela@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'CMO'">
                <xsl:value-of select="'mx.cmorales@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'GM'">
                <xsl:value-of select="'mx.gmendiola@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'LLD'">
                <xsl:value-of select="'mx.llopez@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'KM'">
                <xsl:value-of select="'mx.kmendez@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'JI'">
                <xsl:value-of select="'mx.jivellez@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'BLU'">
                <xsl:value-of select="'mx.blujan@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'CR'">
                <xsl:value-of select="'mx.cramos@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'DS'">
                <xsl:value-of select="'mx.dsanchez@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'JA'">
                <xsl:value-of select="'mx.jargueta@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'ML'">
                <xsl:value-of select="'mx.mlopez@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'PT'">
                <xsl:value-of select="'mx.ptaboada@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'RS'">
                <xsl:value-of select="'mx.rsocarras@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'DT'">
                <xsl:value-of select="'mx.dtellez@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'AD'">
                <xsl:value-of select="'mx.adiaz@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'IL'">
                <xsl:value-of select="'mx.ilopez@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'EVE'">
                <xsl:value-of select="'mx.evelasco@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'KMA'">
                <xsl:value-of select="'mx.kaguilar@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'MMZ'">
                <xsl:value-of select="'mx.mmartinez@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'RGP'">
                <xsl:value-of select="'mx.rgoff@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'CYN'">
                <xsl:value-of select="'mx.cmendez@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'EG'">
                <xsl:value-of select="'mx.ugarcia@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'LC'">
                <xsl:value-of select="'mx.lcontreras@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'FMH'">
                <xsl:value-of select="'mx.fhernandez@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'APZ'">
                <xsl:value-of select="'mx.aperez@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'IMZ'">
                <xsl:value-of select="'mx.imarquez@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'AI'">
                <xsl:value-of select="'mx.airigoyen@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'APZ'">
                <xsl:value-of select="'mx.aperez@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'HB'">
                <xsl:value-of select="'mx.hbernal@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'IP'">
                <xsl:value-of select="'mx.ipineda@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'YR'">
                <xsl:value-of select="'mx.yrodriguez@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'GG'">
                <xsl:value-of select="'mx.ggomez@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'ASN'">
                <xsl:value-of select="'mx.asantillan@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'VC'">
                <xsl:value-of select="'mx.vcolli@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'EI'">
                <xsl:value-of select="'mx.eislas@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'VGA'">
                <xsl:value-of select="'mx.vgarcia@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'MRZ'">
                <xsl:value-of select="'mx.mramirez@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'ATO'">
                <xsl:value-of select="'mx.atrujano@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'SR'">
                <xsl:value-of select="'mx.sruiz@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'VGZ'">
                <xsl:value-of select="'mx.lgonzalez@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'AGA'">
                <xsl:value-of select="'mx.agarcia@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'FG'">
                <xsl:value-of select="'mx.fgrimaldo@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'FR'">
                <xsl:value-of select="'mx.frodriguez@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'ID'">
                <xsl:value-of select="'mx.idegante@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'JC'">
                <xsl:value-of select="'mx.jcruz@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'PE'">
                <xsl:value-of select="'mx.pestrada@kensalogistics.com'"/>
              </xsl:when>
              <xsl:when test="$operadorCode = 'YPG'">
                <xsl:value-of select="'mx.ypuga@kensalogistics.com'"/>
              </xsl:when>
              <xsl:otherwise>
                <xsl:value-of select="'mx.dbaruch@kensalogistics.com'"/>
              </xsl:otherwise>
            </xsl:choose>
          </xsl:variable>

          <xsl:attribute name="email">
            <xsl:value-of select="$correo"/>
          </xsl:attribute>

          <xsl:attribute name="asunto">
            <xsl:value-of select="concat('Shipment number - ', $Shipment)"/>
          </xsl:attribute>

          <xsl:attribute name="adjuntar">
            <xsl:value-of select="'AMBOS'"/>
          </xsl:attribute>

          <xsl:attribute name="mensaje">
            <xsl:value-of select="'Se adjunta CFDi de KENSA Logistics, México.'"/>
          </xsl:attribute>

        </EnvioEmail>
      </Receptor>

      <xsl:variable name="ShipmentTypeBCN">
        <xsl:for-each select="//w:ShipmentType">
          <xsl:value-of select="concat('-', w:Code)"/>
        </xsl:for-each>  </xsl:variable>
      <xsl:variable name="ContainerModeBCN">
        <xsl:for-each select="//w:ContainerMode">
          <xsl:value-of select="concat('-', w:Code)"/>
        </xsl:for-each>  </xsl:variable>

      <xsl:choose>
        <xsl:when test="contains(concat($ShipmentTypeBCN, $ContainerModeBCN), 'BCN')">
          <Conceptos>

            <xsl:for-each
              select="//w:PostingJournalCollection/w:PostingJournal[generate-id() = generate-id(key('ChargeCode', w:ChargeCode/w:Code)[1])]">

              <xsl:sort select="w:Job/w:Key" order="descending"/>

              <xsl:variable name="ChargeCodeCode">
                <xsl:value-of select="w:ChargeCode/w:Code"/>
              </xsl:variable>
              <xsl:variable name="ChargeTypeCode">
                <xsl:value-of select="w:ChargeCode/w:ChargeType/w:Code"/>
              </xsl:variable>

              <xsl:if
                test="$ChargeCodeCode != 'DTA' and $ChargeCodeCode != 'PREVAL' and $ChargeTypeCode != 'CMT'">

                <Concepto>

                  <xsl:variable name="codeTotal">
                    <xsl:value-of select="sum(key('ChargeCode', w:ChargeCode/w:Code/w:OSAmount))"/>
                  </xsl:variable>

                  <xsl:variable name="job" select="w:Job/w:Key"/>

                  <xsl:variable name="TaxRate" select="w:VATTaxID/w:TaxRate"/>

                  <xsl:variable name="TaxCode" select="w:VATTaxID/w:TaxCode"/>

                  <xsl:variable name="origin"
                    select="concat(//w:ShipmentCollection/w:Shipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:PortOfLoading/w:Code, ' / ', //w:ShipmentCollection/w:Shipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:PortOfLoading/w:Name)"/>

                  <xsl:variable name="destination"
                    select="concat(//w:ShipmentCollection/w:Shipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:PortOfDischarge/w:Code, ' / ', //w:ShipmentCollection/w:Shipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:PortOfDischarge/w:Name)"/>

                  <xsl:variable name="TaxCode" select="w:VATTaxID/w:TaxCode"/>

                  <xsl:variable name="GLAccount" select="w:GLAccount/w:AccountCode"/>

                  <xsl:variable name="descripcionOriginal" select="w:Description"/>

                  <xsl:variable name="ClaveProdServ">
                    <xsl:choose>
                      <xsl:when test="$ChargeCodeCode = 'FSC'">
                        <xsl:value-of select="'78101502'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'COMN'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DCDET'">
                        <xsl:value-of select="'78101801'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DADF'">
                        <xsl:value-of select="'78101502'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OTHC'">
                        <xsl:value-of select="'78121601'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OHAND'">
                        <xsl:value-of select="'78121601'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OAWB'">
                        <xsl:value-of select="'78101502'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'CRSBRD'">
                        <xsl:value-of select="'78101806'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'CCLR'">
                        <xsl:value-of select="'80151605'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DCDEM'">
                        <xsl:value-of select="'78101702'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OCDEM'">
                        <xsl:value-of select="'78101702'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DHAND'">
                        <xsl:value-of select="'78121601'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DCART'">
                        <xsl:value-of select="'78101806'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OCDET'">
                        <xsl:value-of select="'78101801'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'IMO'">
                        <xsl:value-of select="'78101702'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OCART'">
                        <xsl:value-of select="'78101806'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'PTRFEE'">
                        <xsl:value-of select="'78101702'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DBILL'">
                        <xsl:value-of select="'78101702'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OBILL'">
                        <xsl:value-of select="'78101702'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'FRTL'">
                        <xsl:value-of select="'78101806'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OSOLAS'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'MANEV'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'ONOTE'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DDOC'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'FNBKCHG'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DTHC'">
                        <xsl:value-of select="'78121601'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DSTOR'">
                        <xsl:value-of select="'78131701'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'GRI'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'ADPOST'">
                        <xsl:value-of select="'78102203'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'PS'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'ODOC'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'FRTO'">
                        <xsl:value-of select="'78101702'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'INBI'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'INSUR'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OSTOR'">
                        <xsl:value-of select="'78131701'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DREL'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OINSP'">
                        <xsl:value-of select="'78141600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'ECUF'">
                        <xsl:value-of select="'80151605'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'ADM FEE'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OFUMI'">
                        <xsl:value-of select="'78141603'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'CONTP'">
                        <xsl:value-of select="'78101702'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'CTDY'">
                        <xsl:value-of select="'78141602'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'FRTA'">
                        <xsl:value-of select="'78101502'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DFUMI'">
                        <xsl:value-of select="'78141603'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DESC'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'EUR1'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OSTUF'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'HAZFEE'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DINSP'">
                        <xsl:value-of select="'78141600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DNOTE'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'AMS'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'COD'">
                        <xsl:value-of select="'78101702'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'FRTMX'">
                        <xsl:value-of select="'78101801'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'FRTCON'">
                        <xsl:value-of select="'78101800'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'FRTAN'">
                        <xsl:value-of select="'78101501'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'FRTON'">
                        <xsl:value-of select="'78101701'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'SDAL'">
                        <xsl:value-of select="'78141501'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'ANTIC'">
                        <xsl:value-of select="'84111506'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'MEDY'">
                        <xsl:value-of select="'78141501'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'REL'">
                        <xsl:value-of select="'888888'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'NCDEV'">
                        <xsl:value-of select="'84111506'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'PCON'">
                        <xsl:value-of select="'78121600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'TONU'">
                        <xsl:value-of select="'78141500'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'COMIF'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'INTM'">
                        <xsl:value-of select="'78141500'"/>
                      </xsl:when>
                      <xsl:when test="$GLAccount = '630.01.000'">
                        <xsl:value-of select="'84101700'"/>
                      </xsl:when>
                      <xsl:when test="$GLAccount = '710.01.002'">
                        <xsl:value-of select="'01010101'"/>
                      </xsl:when>
                      <xsl:when test="$GLAccount = '710.01.002'">
                        <xsl:value-of select="'01010101'"/>
                      </xsl:when>
                      <xsl:when test="$GLAccount = '425.01.000'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$GLAccount = '401.04.000'">
                        <xsl:value-of select="'25101500'"/>
                      </xsl:when>
                      <xsl:when test="$GLAccount = '425.04.000'">
                        <xsl:value-of select="'84111506'"/>
                      </xsl:when>
                    </xsl:choose>
                  </xsl:variable>

                  <xsl:variable name="Desc">
                    <xsl:choose>
                      <xsl:when test="$ChargeCodeCode = 'CSCF'">
                        <xsl:value-of select="'Tarifa de Consultoría de Seguro de Contendores'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'ISPS'">
                        <xsl:value-of
                          select="'Código Int. para la Protección de los Buques y de las Instalaciones Portuarias'"
                        />
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'ADM FEE'">
                        <xsl:value-of select="'Cargo por Administración'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'COMN'">
                        <xsl:value-of select="'Comisones'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'ADPOST'">
                        <xsl:value-of select="'Gastos de Envío y Mensajeria'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'AMS'">
                        <xsl:value-of select="'AMS'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'CCLR'">
                        <xsl:value-of select="'Despacho Aduanal'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'CONTP'">
                        <xsl:value-of select="'Contenedor Premium'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'CRSBRD'">
                        <xsl:value-of select="'Cruce de Frontera'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'CTDY'">
                        <xsl:value-of select="'Custodia'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DADF'">
                        <xsl:value-of select="'Cargo por Documentacion de Aerolínea en Origen'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DBILL'">
                        <xsl:value-of select="'Liberación de BL en destino'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DCART'">
                        <xsl:value-of select="'Entrega en Destino'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DCDEM'">
                        <xsl:value-of select="translate(w:Description, '&#xA;', ' ')"/>
                        <!--<xsl:value-of select="'Demoras de Contenedor en Destino'"/>-->
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DCDET'">
                        <xsl:value-of select="'Detención de Unidad en Destino'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DDOC'">
                        <xsl:value-of select="'Cargo por Documentación en Destino'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DESC'">
                        <xsl:value-of select="'Desconsolidación'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DFUMI'">
                        <xsl:value-of select="'Cargo por Fumigación en Destino'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DHAND'">
                        <xsl:value-of select="'Manejo en Destino'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DINSP'">
                        <xsl:value-of select="'Inspección de Aduana en Destino'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DNOTE'">
                        <xsl:value-of select="$descripcionOriginal"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DREL'">
                        <xsl:value-of select="'Cargo por Liberación en Destino'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DSTOR'">
                        <xsl:value-of select="'Almacenaje en Destino'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DTHC'">
                        <xsl:value-of select="'Cargos por Manejor en Terminal de Destino'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'ECUF'">
                        <xsl:value-of select="'Cargo Aduanal EDI'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'EUR1'">
                        <xsl:value-of select="'EUR1'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'FNBKCHG'">
                        <xsl:value-of select="'Cargos de bancos'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'FREETEXT'">
                        <xsl:value-of select="'Texto libre'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'FRTA'">
                        <xsl:value-of select="'Flete Internacional Aéreo'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'FRTL'">
                        <xsl:value-of select="'Flete Internacional Terrestre'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'FRTO'">
                        <xsl:value-of select="translate(w:Description, '&#xA;', ' ')"/>
                        <!--<xsl:value-of select="'Flete Internacional Marítimo'"/>-->
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'FSC'">
                        <xsl:value-of select="'Cargo por Combustible'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'GRI'">
                        <xsl:value-of select="'Incremento General de Tarifa'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'HAZFEE'">
                        <xsl:value-of select="'Cargo por Carga Peligrosa'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'IMO'">
                        <xsl:value-of select="'IMO 2020.'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'INBI'">
                        <xsl:value-of select="'Cargo por INBOND'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'INSUR'">
                        <xsl:value-of select="'Cargo por Consultoria de Seguro'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'MANEV'">
                        <xsl:value-of select="'Maniobras'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OAWB'">
                        <xsl:value-of select="'Corte de Guía Aéreo'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OBILL'">
                        <xsl:value-of select="'Emisión de BL en Origen'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OCART'">
                        <xsl:value-of select="'Recolección en origen'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OCDEM'">
                        <xsl:value-of select="'Demoras de Contenedor en origen'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OCDET'">
                        <xsl:value-of select="'Detención de Unidad en Origen'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'ODOC'">
                        <xsl:value-of select="'Cargo por Documentación en Origen'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OFUMI'">
                        <xsl:value-of select="'Fumigación en Origen'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OHAND'">
                        <xsl:value-of select="'Manejo en Origen'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OINSP'">
                        <xsl:value-of select="'Inspección en Aduana en Origen'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'ONOTE'">
                        <xsl:value-of select="$descripcionOriginal"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OSOLAS'">
                        <xsl:value-of select="'Cargo por pesaje VGM SOLAS'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OSTOR'">
                        <xsl:value-of select="'Almacenaje en Origen'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OSTUF'">
                        <xsl:value-of select="'Consolidación'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OTHC'">
                        <xsl:value-of select="'Cargo por Manejo en Terminal de Origen'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'PS'">
                        <xsl:value-of select="'Rebate'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'PTRFEE'">
                        <xsl:value-of select="'Cargo por Transferencia de Puerto'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'FRTMX'">
                        <xsl:value-of select="'Flete Terrestre Local'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'FRTM'">
                        <xsl:value-of select="'Servicios de Fletamento'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'FRTCON'">
                        <xsl:value-of select="'Flete Terrestre Nacional Consolidado'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'FRTAN'">
                        <xsl:value-of select="'Flete Aéreo Nacional'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'FRTON'">
                        <xsl:value-of select="'Flete Marítimo Nacional'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'SDAL'">
                        <xsl:value-of select="'Servicios de Administración Logistica'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'ANTIC'">
                        <xsl:value-of select="'Anticipo de Servicios Logisticos'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'MEDY'">
                        <xsl:value-of select="w:Description"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'NCDEV'">
                        <xsl:value-of select="'Devoluciones, descuentos o bonificaciones'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'PCON'">
                        <xsl:value-of select="'Acondicionamiento de Empaque'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'TONU'">
                        <xsl:value-of select="'Flete en Falso'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'COMIF'">
                        <xsl:value-of select="'Servicios de Coordinación Logística'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'INTM'">
                        <xsl:value-of select="'Coordinación de Logística Intermodal'"/>
                      </xsl:when>
                      <xsl:when test="$GLAccount = '630.01.000'">
                        <xsl:value-of select="'Intereses'"/>
                      </xsl:when>
                      <xsl:when test="$GLAccount = '710.01.002'">
                        <xsl:value-of select="'Otros ingresos'"/>
                      </xsl:when>
                      <xsl:when test="$GLAccount = '401.03.000'">
                        <xsl:value-of select="w:Description"/>
                      </xsl:when>
                      <xsl:when test="$GLAccount = '425.01.000'">
                        <xsl:value-of select="w:Description"/>
                      </xsl:when>
                      <xsl:when test="$GLAccount = '401.04.000'">
                        <xsl:value-of select="w:Description"/>
                      </xsl:when>
                      <xsl:when test="$GLAccount = '425.04.000'">
                        <xsl:value-of select="'Devoluciones, descuentos o bonificaciones'"/>
                      </xsl:when>
                    </xsl:choose>
                  </xsl:variable>

                  <xsl:variable name="Importe">
                    <xsl:choose>
                      <xsl:when test="w:OSAmount &lt; 0">
                        <xsl:value-of
                          select="format-number(sum(key('ChargeCode', w:ChargeCode/w:Code)/w:OSAmount) * -1, '#.00')"
                        />
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:value-of
                          select="format-number(sum(key('ChargeCode', w:ChargeCode/w:Code)/w:OSAmount), '#.00')"
                        />
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:variable>

                  <xsl:variable name="ImporteImpuesto">

                    <!--
                      
                      Comenté esto porque me estaba dando mal redondeo en algunos casos y me fui por la multiplicación
                      
                      <xsl:choose>
                      <xsl:when test="w:OSGSTVATAmount &lt; 0">
                        <xsl:value-of
                          select="format-number(sum(key('ChargeCode', w:ChargeCode/w:Code)/w:OSGSTVATAmount) * -1, '#.00')"
                        />
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:value-of
                          select="format-number(sum(key('ChargeCode', w:ChargeCode/w:Code)/w:OSGSTVATAmount), '0.00')"
                        />
                      </xsl:otherwise>
                    </xsl:choose>-->

                    <xsl:value-of select="format-number($Importe * 0.16, '0.00')"/>
                  </xsl:variable>

                  <xsl:variable name="ImporteRetencion">
                    <xsl:choose>
                      <xsl:when test="w:OSExtraVATAmount &lt; 0">
                        <xsl:value-of
                          select="format-number(sum(key('ChargeCode', w:ChargeCode/w:Code)/w:OSExtraVATAmount) * -1, '#.00')"
                        />
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:value-of
                          select="format-number(sum(key('ChargeCode', w:ChargeCode/w:Code)/w:OSExtraVATAmount), '0.00')"
                        />
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:variable>

                  <xsl:variable name="departamentoName" select="w:Department/w:Name"/>

                  <xsl:variable name="departamentoCode" select="w:Department/w:Code"/>

                  <xsl:attribute name="ClaveProdServ">
                    <xsl:value-of select="w:GovernmentReportingChargeCode"/>
                  </xsl:attribute>

                  <xsl:attribute name="NoIdentificacion">
                    <xsl:choose>
                      <xsl:when test="$GLAccount = '630.01.000'">
                        <xsl:value-of select="$GLAccount"/>
                      </xsl:when>
                      <xsl:when test="$GLAccount = '710.01.002'">
                        <xsl:value-of select="$GLAccount"/>
                      </xsl:when>
                      <xsl:when test="$GLAccount = '401.03.000'">
                        <xsl:value-of select="$GLAccount"/>
                      </xsl:when>
                      <xsl:when test="$GLAccount = '425.01.000'">
                        <xsl:value-of select="$GLAccount"/>
                      </xsl:when>
                      <xsl:when test="$GLAccount = '401.04.000'">
                        <xsl:value-of select="$GLAccount"/>
                      </xsl:when>
                      <xsl:when test="$GLAccount = '425.04.000'">
                        <xsl:value-of select="$GLAccount"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:value-of select="$ChargeCodeCode"/>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:attribute>

                  <xsl:attribute name="unidad">
                    <xsl:value-of select="'No Aplica'"/>
                  </xsl:attribute>

                  <xsl:attribute name="ClaveUnidad">
                    <xsl:choose>
                      <xsl:when test="$ChargeCodeCode = 'NCDEV' or contains($GLAccount, '425.0')">
                        <xsl:value-of select="'ACT'"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:value-of select="'E48'"/>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:attribute>

                  <xsl:attribute name="Cantidad">
                    <xsl:value-of select="'1'"/>
                  </xsl:attribute>

                  <xsl:attribute name="categoria">
                    <xsl:choose>
                      <xsl:when test="$TaxCode = 'FREEIVA'">
                        <xsl:value-of select="'0%'"/>
                      </xsl:when>
                      <xsl:when test="$TaxCode = 'IVA'">
                        <xsl:value-of select="'16%'"/>
                      </xsl:when>
                      <xsl:when test="$TaxCode = 'CAPIVA'">
                        <xsl:value-of select="'16%'"/>
                      </xsl:when>
                      <xsl:when test="$TaxCode = 'IVA4'">
                        <xsl:value-of select="'16% sobre base 25%'"/>
                      </xsl:when>
                      <xsl:when test="$TaxCode = 'FREEIVA'">
                        <xsl:value-of select="'0%'"/>
                      </xsl:when>
                      <xsl:when test="$TaxCode = 'EXEMPT'">
                        <xsl:value-of select="'Exento'"/>
                      </xsl:when>
                      <xsl:when test="$TaxCode = 'NOTREPORT'">
                        <xsl:value-of select="'No objeto de IVA'"/>
                      </xsl:when>
                      <xsl:when test="$TaxCode = 'IVARET'">
                        <xsl:value-of select="'16% - 4% Ret'"/>
                      </xsl:when>
                    </xsl:choose>
                  </xsl:attribute>

                  <xsl:attribute name="Descripcion">
                    <xsl:value-of select="$Desc"/>
                  </xsl:attribute>

                  <xsl:attribute name="ValorUnitario">
                    <xsl:value-of select="format-number($Importe, '0.00')"/>
                  </xsl:attribute>

                  <xsl:attribute name="Importe">
                    <xsl:value-of select="format-number($Importe, '0.00')"/>
                  </xsl:attribute>

                  <xsl:attribute name="ObjetoImp">
                    <xsl:choose>
                      <xsl:when test="$TaxCode = 'EXEMPT'">
                        <xsl:value-of select="'01'"/>
                      </xsl:when>
                      <xsl:when test="$TaxCode = 'NOTREPORT'">
                        <xsl:value-of select="'01'"/>
                      </xsl:when>
                      <xsl:when test="$TaxCode = 'FREEIVA'">
                        <xsl:value-of select="'02'"/>
                      </xsl:when>
                      <xsl:when test="$TaxCode = 'IVA'">
                        <xsl:value-of select="'02'"/>
                      </xsl:when>
                      <xsl:when test="$TaxCode = 'CAPIVA'">
                        <xsl:value-of select="'02'"/>
                      </xsl:when>
                      <xsl:when test="$TaxCode = 'IVARET'">
                        <xsl:value-of select="'02'"/>
                      </xsl:when>
                      <xsl:when test="$TaxCode = 'IVA4'">
                        <xsl:value-of select="'02'"/>
                      </xsl:when>
                    </xsl:choose>
                  </xsl:attribute>

                  <xsl:variable name="absImpTrans">
                    <xsl:choose>
                      <xsl:when test="w:OSGSTVATAmount &lt; 0">
                        <xsl:value-of select="sum(key('ChargeCode', w:OSGSTVATAmount)) * -1"/>
                      </xsl:when>
                      <xsl:when test="not(w:OSGSTVATAmount)">
                        <xsl:value-of select="0"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:value-of select="sum(key('ChargeCode', w:OSGSTVATAmount))"/>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:variable>

                  <xsl:variable name="absImpRet">
                    <xsl:choose>
                      <xsl:when test="w:OSExtraVATAmount &lt; 0">
                        <xsl:value-of select="w:OSExtraVATAmount * -1"/>
                      </xsl:when>
                      <xsl:when test="not(w:OSExtraVATAmount)">
                        <xsl:value-of select="0"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:value-of select="w:OSExtraVATAmount"/>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:variable>

                  <xsl:variable name="ImporteTransferido">
                    <xsl:choose>
                      <xsl:when test="$absImpRet">
                        <xsl:value-of select="$absImpTrans + $absImpRet"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:value-of select="$absImpTrans"/>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:variable>

                  <xsl:variable name="house">
                    <xsl:choose>
                      <xsl:when
                        test="//w:ShipmentCollection/w:Shipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:SubShipmentCollection/w:SubShipment/w:SubShipmentCollection/w:SubShipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:WayBillNumber">
                        <xsl:value-of
                          select="//w:ShipmentCollection/w:Shipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:SubShipmentCollection/w:SubShipment/w:SubShipmentCollection/w:SubShipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:WayBillNumber"
                        />
                      </xsl:when>
                      <xsl:when
                        test="//w:ShipmentCollection/w:Shipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:SubShipmentCollection/w:SubShipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:WayBillNumber">
                        <xsl:value-of
                          select="//w:ShipmentCollection/w:Shipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:SubShipmentCollection/w:SubShipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:WayBillNumber"
                        />
                      </xsl:when>
                    </xsl:choose>
                  </xsl:variable>

                  <xsl:variable name="consignor">
                    <xsl:choose>
                      <xsl:when
                        test="//w:ShipmentCollection/w:Shipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:SubShipmentCollection/w:SubShipment/w:SubShipmentCollection/w:SubShipment/w:OrganizationAddressCollection/w:OrganizationAddress[w:AddressType = 'ConsignorDocumentaryAddress']/w:CompanyName">
                        <xsl:value-of
                          select="//w:ShipmentCollection/w:Shipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:SubShipmentCollection/w:SubShipment/w:SubShipmentCollection/w:SubShipment/w:OrganizationAddressCollection/w:OrganizationAddress[w:AddressType = 'ConsignorDocumentaryAddress']/w:CompanyName"
                        />
                      </xsl:when>
                      <xsl:when
                        test="//w:ShipmentCollection/w:Shipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:SubShipmentCollection/w:SubShipment/w:OrganizationAddressCollection/w:OrganizationAddress[w:AddressType = 'ConsignorDocumentaryAddress']/w:CompanyName">
                        <xsl:value-of
                          select="//w:ShipmentCollection/w:Shipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:SubShipmentCollection/w:SubShipment/w:OrganizationAddressCollection/w:OrganizationAddress[w:AddressType = 'ConsignorDocumentaryAddress']/w:CompanyName"
                        />
                      </xsl:when>
                    </xsl:choose>
                  </xsl:variable>

                  <xsl:variable name="consignee">
                    <xsl:choose>
                      <xsl:when
                        test="//w:ShipmentCollection/w:Shipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:SubShipmentCollection/w:SubShipment/w:SubShipmentCollection/w:SubShipment/w:OrganizationAddressCollection/w:OrganizationAddress[w:AddressType = 'ConsigneeDocumentaryAddress']/w:CompanyName">
                        <xsl:value-of
                          select="//w:ShipmentCollection/w:Shipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:SubShipmentCollection/w:SubShipment/w:SubShipmentCollection/w:SubShipment/w:OrganizationAddressCollection/w:OrganizationAddress[w:AddressType = 'ConsigneeDocumentaryAddress']/w:CompanyName"
                        />
                      </xsl:when>
                      <xsl:when
                        test="//w:ShipmentCollection/w:Shipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:SubShipmentCollection/w:SubShipment/w:OrganizationAddressCollection/w:OrganizationAddress[w:AddressType = 'ConsigneeDocumentaryAddress']/w:CompanyName">
                        <xsl:value-of
                          select="//w:ShipmentCollection/w:Shipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:SubShipmentCollection/w:SubShipment/w:OrganizationAddressCollection/w:OrganizationAddress[w:AddressType = 'ConsigneeDocumentaryAddress']/w:CompanyName"
                        />
                      </xsl:when>
                    </xsl:choose>
                  </xsl:variable>

                  <xsl:variable name="containers">
                    <xsl:for-each
                      select="//w:ShipmentCollection/w:Shipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:ContainerCollection/w:Container">
                      <xsl:value-of select="concat(w:ContainerNumber, ', ')"/>
                    </xsl:for-each>
                  </xsl:variable>

                  <xsl:variable name="GoodsDescription"
                    select="//w:ShipmentCollection/w:Shipment/w:SubShipmentCollection/w:SubShipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:GoodsDescription"/>

                  <xsl:variable name="OrderRef">
                    <xsl:for-each
                      select="//w:ShipmentCollection/w:Shipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]//w:LocalProcessing/w:OrderNumberCollection/w:OrderNumber">
                      <xsl:value-of select="concat(w:OrderReference, ', ')"/>
                    </xsl:for-each>
                  </xsl:variable>

                  <xsl:variable name="valorBaseIVA" select="$Importe"/>
                  <xsl:variable name="valorImporteIVA" select="$ImporteImpuesto"/>

                  <xsl:variable name="valorBaseIVA4" select="round($Importe div 4 * 100) div 100"/>
                  <xsl:variable name="valorImporteIVA4" select="$ImporteImpuesto"/>

                  <xsl:variable name="valorBaseFREEIVA4"
                    select="round($Importe div 4 * 3 * 100) div 100"/>
                  <xsl:variable name="valorImporteFREEIVA4" select="0"/>

                  <xsl:variable name="valorBaseFREEIVA" select="$Importe"/>
                  <xsl:variable name="valorImporteFREEIVA" select="0"/>

                  <xsl:variable name="valorBaseIVARET" select="$Importe"/>
                  <xsl:variable name="valorImporteTraIVARET"
                    select="$ImporteImpuesto + $ImporteRetencion"/>
                  <xsl:variable name="valorImporteRetIVARET" select="$ImporteRetencion"/>
                  
                  <xsl:attribute name="tax">
                    <xsl:value-of select="$TaxCode"/>
                  </xsl:attribute>
                  
                  <xsl:if test="$TaxCode != 'EXEMPT' and $TaxCode != 'NOTREPORT'">
                    <Impuestos>

                      <Traslados>
                        <xsl:choose>

                          <xsl:when test="$TaxCode = 'IVA' or $TaxCode = 'CAPIVA'">
                            <Traslado>
                              <xsl:attribute name="Impuesto">
                                <xsl:value-of select="'002'"/>
                              </xsl:attribute>
                              <xsl:attribute name="Base">
                                <xsl:value-of select="format-number($Importe, '0.00')"/>
                              </xsl:attribute>
                              <xsl:attribute name="TipoFactor">
                                <xsl:value-of select="'Tasa'"/>
                              </xsl:attribute>
                              <xsl:attribute name="TasaOCuota">
                                <xsl:value-of select="'0.160000'"/>
                              </xsl:attribute>
                              <xsl:attribute name="Importe">
                                <xsl:value-of select="format-number($valorImporteIVA, '0.00')"/>
                              </xsl:attribute>
                            </Traslado>
                          </xsl:when>

                          <xsl:when test="$TaxCode = 'IVA4'">
                            <Traslado>
                              <xsl:attribute name="Impuesto">
                                <xsl:value-of select="'002'"/>
                              </xsl:attribute>
                              <xsl:attribute name="Base">
                                <xsl:value-of select="format-number($valorBaseIVA4, '0.00')"/>
                              </xsl:attribute>
                              <xsl:attribute name="TipoFactor">
                                <xsl:value-of select="'Tasa'"/>
                              </xsl:attribute>
                              <xsl:attribute name="TasaOCuota">
                                <xsl:value-of select="'0.160000'"/>
                              </xsl:attribute>
                              <xsl:attribute name="Importe">
                                <xsl:value-of select="format-number($valorImporteIVA4, '0.00')"/>
                              </xsl:attribute>
                            </Traslado>

                            <Traslado>
                              <xsl:attribute name="Impuesto">
                                <xsl:value-of select="'002'"/>
                              </xsl:attribute>
                              <xsl:attribute name="Base">
                                <xsl:value-of select="format-number($valorBaseFREEIVA4, '0.00')"/>
                              </xsl:attribute>
                              <xsl:attribute name="TipoFactor">
                                <xsl:value-of select="'Tasa'"/>
                              </xsl:attribute>
                              <xsl:attribute name="TasaOCuota">
                                <xsl:value-of select="'0.000000'"/>
                              </xsl:attribute>
                              <xsl:attribute name="Importe">
                                <xsl:value-of select="format-number($valorImporteFREEIVA4, '0.00')"
                                />
                              </xsl:attribute>
                            </Traslado>
                          </xsl:when>

                          <xsl:when test="$TaxCode = 'FREEIVA'">
                            <Traslado>
                              <xsl:attribute name="Impuesto">
                                <xsl:value-of select="'002'"/>
                              </xsl:attribute>
                              <xsl:attribute name="Base">
                                <xsl:value-of select="format-number($valorBaseFREEIVA, '0.00')"/>
                              </xsl:attribute>
                              <xsl:attribute name="TipoFactor">
                                <xsl:value-of select="'Tasa'"/>
                              </xsl:attribute>
                              <xsl:attribute name="TasaOCuota">
                                <xsl:value-of select="'0.000000'"/>
                              </xsl:attribute>
                              <xsl:attribute name="Importe">
                                <xsl:value-of select="format-number($valorImporteFREEIVA, '0.00')"/>
                              </xsl:attribute>
                            </Traslado>
                          </xsl:when>

                          <xsl:when test="$TaxCode = 'IVARET'">
                            <Traslado>
                              <xsl:attribute name="Impuesto">
                                <xsl:value-of select="'002'"/>
                              </xsl:attribute>
                              <xsl:attribute name="Base">
                                <xsl:value-of select="format-number($valorBaseIVARET, '0.00')"/>
                              </xsl:attribute>
                              <xsl:attribute name="TipoFactor">
                                <xsl:value-of select="'Tasa'"/>
                              </xsl:attribute>
                              <xsl:attribute name="TasaOCuota">
                                <xsl:value-of select="'0.160000'"/>
                              </xsl:attribute>
                              <xsl:attribute name="Importe">
                                <xsl:value-of select="format-number($valorImporteTraIVARET, '0.00')"
                                />
                              </xsl:attribute>
                            </Traslado>
                          </xsl:when>

                        </xsl:choose>
                      </Traslados>

                      <!-- Impuestos Retenciones -->
                      <xsl:if test="$TaxCode = 'IVARET'">
                        <Retenciones>
                          <Retencion>
                            <xsl:attribute name="Impuesto">
                              <xsl:value-of select="'002'"/>
                            </xsl:attribute>
                            <xsl:attribute name="Base">
                              <xsl:value-of select="format-number($valorBaseIVARET, '0.00')"/>
                            </xsl:attribute>
                            <xsl:attribute name="TipoFactor">
                              <xsl:value-of select="'Tasa'"/>
                            </xsl:attribute>
                            <xsl:attribute name="TasaOCuota">
                              <xsl:value-of select="'0.040000'"/>
                            </xsl:attribute>
                            <xsl:attribute name="Importe">
                              <xsl:value-of select="format-number($valorImporteRetIVARET, '0.00')"/>
                            </xsl:attribute>
                          </Retencion>
                        </Retenciones>
                      </xsl:if>
                    </Impuestos>
                  </xsl:if>

                  <!--Información Adicional-->

                  <InformacionAdicional>
                    <xsl:element name="impuesto">
                      <xsl:value-of select="$TaxCode"/>
                    </xsl:element>

                    <xsl:element name="ClaveProdServ">
                      <xsl:value-of select="w:GovernmentReportingChargeCode"/>
                    </xsl:element>

                    <xsl:element name="ClaveUnidad">
                      <xsl:choose>
                        <xsl:when test="$ChargeCodeCode = 'NCDEV' or contains($GLAccount, '425.0')">
                          <xsl:value-of select="'ACT'"/>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:value-of select="'E48'"/>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:element>

                    <xsl:element name="Cantidad">
                      <xsl:value-of select="'1'"/>
                    </xsl:element>

                    <xsl:element name="categoria">
                      <xsl:value-of
                        select="concat($departamentoCode, ' - ', $departamentoName, ' - ', $ChargeCodeCode)"
                      />
                    </xsl:element>

                    <xsl:element name="Descripcion">
                      <xsl:value-of select="translate(w:Description, '|', '')"/>
                    </xsl:element>

                    <xsl:element name="ValorUnitario">
                      <xsl:value-of select="format-number($Importe, '#,##0.00')"/>
                    </xsl:element>

                    <xsl:element name="Importe">
                      <xsl:value-of select="format-number($Importe, '#,##0.00')"/>
                    </xsl:element>

                    <xsl:element name="Base">
                      <xsl:choose>
                        <xsl:when test="$TaxCode = 'IVA4'">
                          <xsl:value-of select="format-number($Importe div 4, '#,##0.00')"/>
                        </xsl:when>
                        <xsl:when test="$TaxCode = 'IVA'">
                          <xsl:value-of select="format-number($Importe, '#,##0.00')"/>
                        </xsl:when>
                        <xsl:when test="$TaxCode = 'IVARET'">
                          <xsl:value-of select="format-number($Importe, '#,##0.00')"/>
                        </xsl:when>
                        <xsl:when test="$TaxCode = 'FREEIVA'">
                          <xsl:value-of select="format-number($Importe, '#,##0.00')"/>
                        </xsl:when>
                        <xsl:when test="$TaxCode = 'EXEMPT'">
                          <xsl:value-of select="format-number($Importe, '#,##0.00')"/>
                        </xsl:when>
                      </xsl:choose>
                    </xsl:element>

                    <xsl:element name="job">
                      <xsl:value-of select="w:Job/w:Key"/>
                    </xsl:element>
                    <xsl:element name="house">
                      <xsl:value-of select="$house"/>
                    </xsl:element>
                    <xsl:element name="origin">
                      <xsl:value-of select="$origin"/>
                    </xsl:element>
                    <xsl:element name="destination">
                      <xsl:value-of select="$destination"/>
                    </xsl:element>
                    <xsl:element name="consignor">
                      <xsl:value-of select="$consignor"/>
                    </xsl:element>
                    <xsl:element name="consignee">
                      <xsl:value-of select="$consignee"/>
                    </xsl:element>
                    <xsl:element name="tipoImpuesto">
                      <xsl:choose>
                        <xsl:when test="$TaxCode = 'IVA4'">
                          <xsl:value-of select="'IVA 16% al 25%'"/>
                        </xsl:when>
                        <xsl:when test="$TaxCode = 'IVA'">
                          <xsl:value-of select="'IVA 16%'"/>
                        </xsl:when>
                        <xsl:when test="$TaxCode = 'IVARET'">
                          <xsl:value-of select="'IVA 16% - RET 4%'"/>
                        </xsl:when>
                        <xsl:when test="$TaxCode = 'FREEIVA'">
                          <xsl:value-of select="'IVA 0%'"/>
                        </xsl:when>
                        <xsl:when test="$TaxCode = 'EXEMPT'">
                          <xsl:value-of select="'EXENTO'"/>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:value-of select="$TaxCode"/>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:element>
                    <xsl:element name="importeImpuesto">
                      <xsl:value-of select="format-number($ImporteTransferido, '#,##0.00')"/>
                    </xsl:element>

                    <xsl:element name="importeTotal">
                      <xsl:value-of
                        select="format-number($Importe + $ImporteTransferido, '#,##0.00')"/>
                    </xsl:element>

                    <xsl:element name="containers">
                      <xsl:value-of
                        select="substring($containers, 0, string-length($containers) - 1)"/>
                    </xsl:element>
                    <xsl:element name="goodsDescription">
                      <xsl:value-of select="$GoodsDescription"/>
                    </xsl:element>
                    <xsl:element name="OrderRef">
                      <xsl:value-of select="substring($OrderRef, 0, string-length($OrderRef) - 1)"/>
                    </xsl:element>
                  </InformacionAdicional>
                </Concepto>

              </xsl:if>
            </xsl:for-each>
          </Conceptos>
        </xsl:when>
        <xsl:otherwise>
          <Conceptos>
            <xsl:for-each select="//w:PostingJournalCollection/w:PostingJournal">

              <xsl:sort select="w:Job/w:Key" order="descending"/>

              <xsl:variable name="ChargeCodeCode">
                <xsl:value-of select="w:ChargeCode/w:Code"/>
              </xsl:variable>
              <xsl:variable name="ChargeTypeCode">
                <xsl:value-of select="w:ChargeCode/w:ChargeType/w:Code"/>
              </xsl:variable>

              <xsl:if
                test="$ChargeCodeCode != 'DTA' and $ChargeCodeCode != 'PREVAL' and $ChargeTypeCode != 'CMT'">

                <Concepto>
                  <xsl:variable name="codeTotal">
                    <xsl:value-of select="sum(key('ChargeCode', w:ChargeCode/w:Code/w:OSAmount))"/>
                  </xsl:variable>

                  <xsl:variable name="job" select="w:Job/w:Key"/>

                  <xsl:variable name="TaxRate" select="w:VATTaxID/w:TaxRate"/>

                  <xsl:variable name="TaxCode" select="w:VATTaxID/w:TaxCode"/>

                  <xsl:variable name="origin"
                    select="concat(//w:ShipmentCollection/w:Shipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:PortOfLoading/w:Code, ' / ', //w:ShipmentCollection/w:Shipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:PortOfLoading/w:Name)"/>

                  <xsl:variable name="destination"
                    select="concat(//w:ShipmentCollection/w:Shipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:PortOfDischarge/w:Code, ' / ', //w:ShipmentCollection/w:Shipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:PortOfDischarge/w:Name)"/>

                  <xsl:variable name="GLAccount" select="w:GLAccount/w:AccountCode"/>

                  <xsl:variable name="descripcionOriginal" select="w:Description"/>

                  <xsl:variable name="ClaveProdServ">
                    <xsl:choose>
                      <xsl:when test="$ChargeCodeCode = 'FSC'">
                        <xsl:value-of select="'78101502'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'COMN'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DCDET'">
                        <xsl:value-of select="'78101801'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DADF'">
                        <xsl:value-of select="'78101502'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OTHC'">
                        <xsl:value-of select="'78121601'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OHAND'">
                        <xsl:value-of select="'78121601'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OAWB'">
                        <xsl:value-of select="'78101502'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'CRSBRD'">
                        <xsl:value-of select="'78101806'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'CCLR'">
                        <xsl:value-of select="'80151605'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DCDEM'">
                        <xsl:value-of select="'78101702'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OCDEM'">
                        <xsl:value-of select="'78101702'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DHAND'">
                        <xsl:value-of select="'78121601'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DCART'">
                        <xsl:value-of select="'78101806'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OCDET'">
                        <xsl:value-of select="'78101801'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'IMO'">
                        <xsl:value-of select="'78101702'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OCART'">
                        <xsl:value-of select="'78101806'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'PTRFEE'">
                        <xsl:value-of select="'78101702'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DBILL'">
                        <xsl:value-of select="'78101702'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OBILL'">
                        <xsl:value-of select="'78101702'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'FRTL'">
                        <xsl:value-of select="'78101806'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OSOLAS'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'MANEV'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'ONOTE'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DDOC'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'FNBKCHG'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DTHC'">
                        <xsl:value-of select="'78121601'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DSTOR'">
                        <xsl:value-of select="'78131701'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'GRI'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'ADPOST'">
                        <xsl:value-of select="'78102203'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'PS'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'ODOC'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'FRTO'">
                        <xsl:value-of select="'78101702'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'INBI'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'INSUR'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OSTOR'">
                        <xsl:value-of select="'78131701'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DREL'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OINSP'">
                        <xsl:value-of select="'78141600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'ECUF'">
                        <xsl:value-of select="'80151605'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'ADM FEE'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OFUMI'">
                        <xsl:value-of select="'78141603'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'CONTP'">
                        <xsl:value-of select="'78101702'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'CTDY'">
                        <xsl:value-of select="'78141602'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'FTN'">
                        <xsl:value-of select="'detener facturación'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'FRTA'">
                        <xsl:value-of select="'78101502'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DFUMI'">
                        <xsl:value-of select="'78141603'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DESC'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'EUR1'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OSTUF'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'HAZFEE'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DINSP'">
                        <xsl:value-of select="'78141600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DNOTE'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'AMS'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'COD'">
                        <xsl:value-of select="'78101702'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'FRTMX'">
                        <xsl:value-of select="'78101801'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'FRTCON'">
                        <xsl:value-of select="'78101800'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'FRTAN'">
                        <xsl:value-of select="'78101501'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'FRTON'">
                        <xsl:value-of select="'78101701'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'SDAL'">
                        <xsl:value-of select="'78141501'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'ANTIC'">
                        <xsl:value-of select="'84111506'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'MEDY'">
                        <xsl:value-of select="'78141501'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'MSAL'">
                        <xsl:value-of select="'78141501'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'NCDEV'">
                        <xsl:value-of select="'84111506'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'PCON'">
                        <xsl:value-of select="'78121600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'TONU'">
                        <xsl:value-of select="'78141500'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'COMIF'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'INTM'">
                        <xsl:value-of select="'78141500'"/>
                      </xsl:when>
                      <xsl:when test="$GLAccount = '630.01.000'">
                        <xsl:value-of select="'84101700'"/>
                      </xsl:when>
                      <xsl:when test="$GLAccount = '710.01.002'">
                        <xsl:value-of select="'01010101'"/>
                      </xsl:when>
                      <xsl:when test="$GLAccount = '401.03.000'">
                        <xsl:value-of select="'84101700'"/>
                      </xsl:when>
                      <xsl:when test="$GLAccount = '425.01.000'">
                        <xsl:value-of select="'80151600'"/>
                      </xsl:when>
                      <xsl:when test="$GLAccount = '401.04.000'">
                        <xsl:value-of select="'25101500'"/>
                      </xsl:when>
                      <xsl:when test="$GLAccount = '425.01.000'">
                        <xsl:value-of select="'84111506'"/>
                      </xsl:when>
                      <xsl:when test="$GLAccount = '425.04.000'">
                        <xsl:value-of select="'84111506'"/>
                      </xsl:when>
                    </xsl:choose>
                  </xsl:variable>

                  <xsl:variable name="Desc">
                    <xsl:choose>
                      <xsl:when test="$ChargeCodeCode = 'CSCF'">
                        <xsl:value-of select="'Tarifa de Consultoría de Seguro de Contendores'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'ISPS'">
                        <xsl:value-of
                          select="'Código Int. para la Protección de los Buques y de las Instalaciones Portuarias'"
                        />
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'ADM FEE'">
                        <xsl:value-of select="'Cargo por Administración'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'COMN'">
                        <xsl:value-of select="'Comisones'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'ADPOST'">
                        <xsl:value-of select="'Gastos de Envío y Mensajeria'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'AMS'">
                        <xsl:value-of select="'AMS'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'CCLR'">
                        <xsl:value-of select="'Despacho Aduanal'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'CONTP'">
                        <xsl:value-of select="'Contenedor Premium'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'CRSBRD'">
                        <xsl:value-of select="'Cruce de Frontera'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'CTDY'">
                        <xsl:value-of select="'Custodia'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DADF'">
                        <xsl:value-of select="'Cargo por Documentacion de Aerolínea en Origen'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DBILL'">
                        <xsl:value-of select="'Liberación de BL en destino'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DCART'">
                        <xsl:value-of select="'Entrega en Destino'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DCDEM'">
                        <xsl:value-of select="translate(w:Description, '&#xA;', ' ')"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DCDET'">
                        <xsl:value-of select="'Detención de Unidad en Destino'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DDOC'">
                        <xsl:value-of select="'Cargo por Documentación en Destino'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DESC'">
                        <xsl:value-of select="'Desconsolidación'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DFUMI'">
                        <xsl:value-of select="'Cargo por Fumigación en Destino'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DHAND'">
                        <xsl:value-of select="'Manejo en Destino'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DINSP'">
                        <xsl:value-of select="'Inspección de Aduana en Destino'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DNOTE'">
                        <xsl:value-of select="$descripcionOriginal"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DREL'">
                        <xsl:value-of select="'Cargo por Liberación en Destino'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DSTOR'">
                        <xsl:value-of select="'Almacenaje en Destino'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'DTHC'">
                        <xsl:value-of select="'Cargos por Manejor en Terminal de Destino'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'ECUF'">
                        <xsl:value-of select="'Cargo Aduanal EDI'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'EUR1'">
                        <xsl:value-of select="'EUR1'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'FNBKCHG'">
                        <xsl:value-of select="'Cargos de bancos'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'FREETEXT'">
                        <xsl:value-of select="'Texto libre'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'FRTA'">
                        <xsl:value-of select="'Flete Internacional Aéreo'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'FRTL'">
                        <xsl:value-of select="'Flete Internacional Terrestre'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'FRTO'">
                        <xsl:value-of select="translate(w:Description, '&#xA;', ' ')"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'FSC'">
                        <xsl:value-of select="'Cargo por Combustible'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'GRI'">
                        <xsl:value-of select="'Incremento General de Tarifa'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'HAZFEE'">
                        <xsl:value-of select="'Cargo por Carga Peligrosa'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'IMO'">
                        <xsl:value-of select="'IMO 2020.'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'INBI'">
                        <xsl:value-of select="'Cargo por INBOND'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'INSUR'">
                        <xsl:value-of select="'Cargo por Consultoria de Seguro'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'MANEV'">
                        <xsl:value-of select="'Maniobras'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OAWB'">
                        <xsl:value-of select="'Corte de Guía Aéreo'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OBILL'">
                        <xsl:value-of select="'Emisión de BL en Origen'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OCART'">
                        <xsl:value-of select="'Recolección en origen'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OCDEM'">
                        <xsl:value-of select="'Demoras de Contenedor en origen'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OCDET'">
                        <xsl:value-of select="'Detención de Unidad en Origen'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'ODOC'">
                        <xsl:value-of select="'Cargo por Documentación en Origen'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OFUMI'">
                        <xsl:value-of select="'Fumigación en Origen'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OHAND'">
                        <xsl:value-of select="'Manejo en Origen'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OINSP'">
                        <xsl:value-of select="'Inspección en Aduana en Origen'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'ONOTE'">
                        <xsl:value-of select="$descripcionOriginal"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OSOLAS'">
                        <xsl:value-of select="'Cargo por pesaje VGM SOLAS'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OSTOR'">
                        <xsl:value-of select="'Almacenaje en Origen'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OSTUF'">
                        <xsl:value-of select="'Consolidación'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'OTHC'">
                        <xsl:value-of select="'Cargo por Manejo en Terminal de Origen'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'PS'">
                        <xsl:value-of select="'Rebate'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'PTRFEE'">
                        <xsl:value-of select="'Cargo por Transferencia de Puerto'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'FRTMX'">
                        <xsl:value-of select="'Flete Terrestre Local'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'FRTM'">
                        <xsl:value-of select="'Servicios de Fletamento'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'FRTCON'">
                        <xsl:value-of select="'Flete Terrestre Nacional Consolidado'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'FRTAN'">
                        <xsl:value-of select="'Flete Aéreo Nacional'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'FRTON'">
                        <xsl:value-of select="'Flete Marítimo Nacional'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'SDAL'">
                        <xsl:value-of select="'Servicios de Administración Logistica'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'ANTIC'">
                        <xsl:value-of select="'Anticipo de Servicios Logisticos'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'MEDY'">
                        <xsl:value-of select="w:Description"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'MSAL'">
                        <xsl:value-of select="w:Description"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'NCDEV'">
                        <xsl:value-of select="'Devoluciones, descuentos o bonificaciones'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'PCON'">
                        <xsl:value-of select="'Acondicionamiento de Empaque'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'TONU'">
                        <xsl:value-of select="'Flete en Falso'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'COMIF'">
                        <xsl:value-of select="'Servicios de Coordinación Logística'"/>
                      </xsl:when>
                      <xsl:when test="$ChargeCodeCode = 'INTM'">
                        <xsl:value-of select="'Coordinación de Logística Intermodal'"/>
                      </xsl:when>
                      <xsl:when test="$GLAccount = '630.01.000'">
                        <xsl:value-of select="'Intereses'"/>
                      </xsl:when>
                      <xsl:when test="$GLAccount = '710.01.002'">
                        <xsl:value-of select="w:Description"/>
                      </xsl:when>
                      <xsl:when test="$GLAccount = '401.03.000'">
                        <xsl:value-of select="w:Description"/>
                      </xsl:when>
                      <xsl:when test="$GLAccount = '425.01.000'">
                        <xsl:value-of select="w:Description"/>
                      </xsl:when>
                      <xsl:when test="$GLAccount = '401.04.000'">
                        <xsl:value-of select="w:Description"/>
                      </xsl:when>
                      <xsl:when test="$GLAccount = '425.01.000'">
                        <xsl:value-of select="'Devoluciones, descuentos o bonificaciones'"/>
                      </xsl:when>
                      <xsl:when test="$GLAccount = '425.04.000'">
                        <xsl:value-of select="'Devoluciones, descuentos o bonificaciones'"/>
                      </xsl:when>
                    </xsl:choose>
                  </xsl:variable>

                  <xsl:variable name="Importe">
                    <xsl:choose>
                      <xsl:when test="w:OSAmount &lt; 0">
                        <xsl:value-of select="format-number(w:OSAmount * -1, '#.00')"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:value-of select="format-number(w:OSAmount, '0.00')"/>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:variable>

                  <xsl:variable name="ImporteImpuesto">
                    <xsl:choose>
                      <xsl:when test="w:OSGSTVATAmount &lt; 0">
                        <xsl:value-of select="format-number(w:OSGSTVATAmount * -1, '#.00')"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:value-of select="format-number(w:OSGSTVATAmount, '0.00')"/>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:variable>

                  <xsl:variable name="ImporteRetencion">
                    <xsl:choose>
                      <xsl:when test="w:OSExtraVATAmount &lt; 0">
                        <xsl:value-of select="format-number(w:OSExtraVATAmount * -1, '#.00')"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:value-of select="format-number(w:OSExtraVATAmount, '0.00')"/>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:variable>

                  <xsl:variable name="Descuento">
                    <xsl:choose>
                      <xsl:when test="w:OSAmount &lt; 0 and $tipoDeComprobante = 'I'">
                        <xsl:value-of select="w:OSAmount * -1"/>
                      </xsl:when>
                    </xsl:choose>
                  </xsl:variable>

                  <xsl:variable name="departamentoName" select="w:Department/w:Name"/>

                  <xsl:variable name="departamentoCode" select="w:Department/w:Code"/>

                  <xsl:attribute name="ClaveProdServ">
                    <xsl:value-of select="w:GovernmentReportingChargeCode"/>
                  </xsl:attribute>

                  <xsl:attribute name="NoIdentificacion">
                    <xsl:choose>
                      <xsl:when test="$GLAccount = '630.01.000'">
                        <xsl:value-of select="$GLAccount"/>
                      </xsl:when>
                      <xsl:when test="$GLAccount = '710.01.002'">
                        <xsl:value-of select="$GLAccount"/>
                      </xsl:when>
                      <xsl:when test="$GLAccount = '401.03.000'">
                        <xsl:value-of select="$GLAccount"/>
                      </xsl:when>
                      <xsl:when test="$GLAccount = '425.01.000'">
                        <xsl:value-of select="$GLAccount"/>
                      </xsl:when>
                      <xsl:when test="$GLAccount = '401.04.000'">
                        <xsl:value-of select="$GLAccount"/>
                      </xsl:when>
                      <xsl:when test="$GLAccount = '425.01.000'">
                        <xsl:value-of select="$GLAccount"/>
                      </xsl:when>
                      <xsl:when test="$GLAccount = '425.04.000'">
                        <xsl:value-of select="$GLAccount"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:value-of select="$ChargeCodeCode"/>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:attribute>

                  <xsl:attribute name="unidad">
                    <xsl:value-of select="'No Aplica'"/>
                  </xsl:attribute>

                  <xsl:attribute name="ClaveUnidad">
                    <xsl:choose>
                      <xsl:when test="$ChargeCodeCode = 'NCDEV' or contains($GLAccount, '425.0')">
                        <xsl:value-of select="'ACT'"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:value-of select="'E48'"/>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:attribute>

                  <xsl:attribute name="Cantidad">
                    <xsl:value-of select="'1'"/>
                  </xsl:attribute>

                  <xsl:attribute name="categoria">
                    <xsl:choose>
                      <xsl:when test="$TaxCode = 'FREEIVA'">
                        <xsl:value-of select="'0%'"/>
                      </xsl:when>
                      <xsl:when test="$TaxCode = 'IVA'">
                        <xsl:value-of select="'16%'"/>
                      </xsl:when>
                      <xsl:when test="$TaxCode = 'CAPIVA'">
                        <xsl:value-of select="'16%'"/>
                      </xsl:when>
                      <xsl:when test="$TaxCode = 'IVA4'">
                        <xsl:value-of select="'16% sobre base 25%'"/>
                      </xsl:when>
                      <xsl:when test="$TaxCode = 'FREEIVA'">
                        <xsl:value-of select="'0%'"/>
                      </xsl:when>
                      <xsl:when test="$TaxCode = 'EXEMPT'">
                        <xsl:value-of select="'Exento'"/>
                      </xsl:when>
                      <xsl:when test="$TaxCode = 'NOTREPORT'">
                        <xsl:value-of select="'No objeto de IVA'"/>
                      </xsl:when>
                      <xsl:when test="$TaxCode = 'IVARET'">
                        <xsl:value-of select="'16% - 4% Ret'"/>
                      </xsl:when>
                    </xsl:choose>
                  </xsl:attribute>

                  <xsl:attribute name="Descripcion">
                    <xsl:value-of select="$Desc"/>
                  </xsl:attribute>

                  <xsl:if test="number($Descuento) &gt; 0">
                    <xsl:attribute name="Descuento">
                      <xsl:value-of select="format-number($Descuento, '0.00')"/>
                    </xsl:attribute>
                  </xsl:if>

                  <xsl:attribute name="ValorUnitario">
                    <xsl:value-of select="format-number($Importe, '0.00')"/>
                  </xsl:attribute>

                  <xsl:attribute name="Importe">
                    <xsl:value-of select="format-number($Importe, '0.00')"/>
                  </xsl:attribute>

                  <xsl:attribute name="ObjetoImp">
                    <xsl:choose>
                      <xsl:when test="$TaxCode = 'EXEMPT'">
                        <xsl:value-of select="'01'"/>
                      </xsl:when>
                      <xsl:when test="$TaxCode = 'NOTREPORT'">
                        <xsl:value-of select="'01'"/>
                      </xsl:when>
                      <xsl:when test="$TaxCode = 'FREEIVA'">
                        <xsl:value-of select="'02'"/>
                      </xsl:when>
                      <xsl:when test="$TaxCode = 'IVA'">
                        <xsl:value-of select="'02'"/>
                      </xsl:when>
                      <xsl:when test="$TaxCode = 'CAPIVA'">
                        <xsl:value-of select="'02'"/>
                      </xsl:when>
                      <xsl:when test="$TaxCode = 'IVARET'">
                        <xsl:value-of select="'02'"/>
                      </xsl:when>
                      <xsl:when test="$TaxCode = 'IVA4'">
                        <xsl:value-of select="'02'"/>
                      </xsl:when>
                    </xsl:choose>
                  </xsl:attribute>

                  <xsl:variable name="absImpTrans">
                    <xsl:choose>
                      <xsl:when test="w:OSGSTVATAmount &lt; 0">
                        <xsl:value-of select="w:OSGSTVATAmount * -1"/>
                      </xsl:when>
                      <xsl:when test="not(w:OSGSTVATAmount)">
                        <xsl:value-of select="0"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:value-of select="w:OSGSTVATAmount"/>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:variable>

                  <xsl:variable name="absImpRet">
                    <xsl:choose>
                      <xsl:when test="w:OSExtraVATAmount &lt; 0">
                        <xsl:value-of select="w:OSExtraVATAmount * -1"/>
                      </xsl:when>
                      <xsl:when test="not(w:OSExtraVATAmount)">
                        <xsl:value-of select="0"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:value-of select="w:OSExtraVATAmount"/>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:variable>

                  <xsl:variable name="ImporteTransferido">
                    <xsl:choose>
                      <xsl:when test="$absImpRet">
                        <xsl:value-of select="$absImpTrans + $absImpRet"/>
                      </xsl:when>
                      <xsl:otherwise>
                        <xsl:value-of select="$absImpTrans"/>
                      </xsl:otherwise>
                    </xsl:choose>
                  </xsl:variable>

                  <xsl:variable name="house">
                    <xsl:choose>
                      <xsl:when
                        test="//w:ShipmentCollection/w:Shipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:SubShipmentCollection/w:SubShipment/w:SubShipmentCollection/w:SubShipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:WayBillNumber">
                        <xsl:value-of
                          select="//w:ShipmentCollection/w:Shipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:SubShipmentCollection/w:SubShipment/w:SubShipmentCollection/w:SubShipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:WayBillNumber"
                        />
                      </xsl:when>
                      <xsl:when
                        test="//w:ShipmentCollection/w:Shipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:SubShipmentCollection/w:SubShipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:WayBillNumber">
                        <xsl:value-of
                          select="//w:ShipmentCollection/w:Shipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:SubShipmentCollection/w:SubShipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:WayBillNumber"
                        />
                      </xsl:when>
                    </xsl:choose>
                  </xsl:variable>

                  <xsl:variable name="consignor">
                    <xsl:choose>
                      <xsl:when
                        test="//w:ShipmentCollection/w:Shipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:SubShipmentCollection/w:SubShipment/w:SubShipmentCollection/w:SubShipment/w:OrganizationAddressCollection/w:OrganizationAddress[w:AddressType = 'ConsignorDocumentaryAddress']/w:CompanyName">
                        <xsl:value-of
                          select="//w:ShipmentCollection/w:Shipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:SubShipmentCollection/w:SubShipment/w:SubShipmentCollection/w:SubShipment/w:OrganizationAddressCollection/w:OrganizationAddress[w:AddressType = 'ConsignorDocumentaryAddress']/w:CompanyName"
                        />
                      </xsl:when>
                      <xsl:when
                        test="//w:ShipmentCollection/w:Shipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:SubShipmentCollection/w:SubShipment/w:OrganizationAddressCollection/w:OrganizationAddress[w:AddressType = 'ConsignorDocumentaryAddress']/w:CompanyName">
                        <xsl:value-of
                          select="//w:ShipmentCollection/w:Shipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:SubShipmentCollection/w:SubShipment/w:OrganizationAddressCollection/w:OrganizationAddress[w:AddressType = 'ConsignorDocumentaryAddress']/w:CompanyName"
                        />
                      </xsl:when>
                    </xsl:choose>
                  </xsl:variable>

                  <xsl:variable name="consignee">
                    <xsl:choose>
                      <xsl:when
                        test="//w:ShipmentCollection/w:Shipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:SubShipmentCollection/w:SubShipment/w:SubShipmentCollection/w:SubShipment/w:OrganizationAddressCollection/w:OrganizationAddress[w:AddressType = 'ConsigneeDocumentaryAddress']/w:CompanyName">
                        <xsl:value-of
                          select="//w:ShipmentCollection/w:Shipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:SubShipmentCollection/w:SubShipment/w:SubShipmentCollection/w:SubShipment/w:OrganizationAddressCollection/w:OrganizationAddress[w:AddressType = 'ConsigneeDocumentaryAddress']/w:CompanyName"
                        />
                      </xsl:when>
                      <xsl:when
                        test="//w:ShipmentCollection/w:Shipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:SubShipmentCollection/w:SubShipment/w:OrganizationAddressCollection/w:OrganizationAddress[w:AddressType = 'ConsigneeDocumentaryAddress']/w:CompanyName">
                        <xsl:value-of
                          select="//w:ShipmentCollection/w:Shipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:SubShipmentCollection/w:SubShipment/w:OrganizationAddressCollection/w:OrganizationAddress[w:AddressType = 'ConsigneeDocumentaryAddress']/w:CompanyName"
                        />
                      </xsl:when>
                    </xsl:choose>
                  </xsl:variable>

                  <xsl:variable name="containers">
                    <xsl:for-each
                      select="//w:ShipmentCollection/w:Shipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:ContainerCollection/w:Container">
                      <xsl:value-of select="concat(w:ContainerNumber, ', ')"/>
                    </xsl:for-each>
                  </xsl:variable>

                  <xsl:variable name="GoodsDescription"
                    select="//w:ShipmentCollection/w:Shipment/w:SubShipmentCollection/w:SubShipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:GoodsDescription"/>

                  <xsl:variable name="OrderRef">
                    <xsl:for-each
                      select="//w:ShipmentCollection/w:Shipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]//w:LocalProcessing/w:OrderNumberCollection/w:OrderNumber">
                      <xsl:value-of select="concat(w:OrderReference, ', ')"/>
                    </xsl:for-each>
                  </xsl:variable>

                  <xsl:variable name="valorBaseIVA" select="$Importe"/>
                  <xsl:variable name="valorImporteIVA" select="$ImporteImpuesto"/>

                  <xsl:variable name="valorBaseIVA4" select="round($Importe div 4 * 100) div 100"/>
                  <xsl:variable name="valorImporteIVA4" select="$ImporteImpuesto"/>

                  <xsl:variable name="valorBaseFREEIVA4"
                    select="round($Importe div 4 * 3 * 100) div 100"/>
                  <xsl:variable name="valorImporteFREEIVA4" select="0"/>

                  <xsl:variable name="valorBaseFREEIVA" select="$Importe"/>
                  <xsl:variable name="valorImporteFREEIVA" select="0"/>

                  <xsl:variable name="valorBaseIVARET" select="$Importe"/>
                  <xsl:variable name="valorImporteTraIVARET"
                    select="$ImporteImpuesto + $ImporteRetencion"/>
                  <xsl:variable name="valorImporteRetIVARET" select="$ImporteRetencion"/>

                  <xsl:if test="$TaxCode != 'EXEMPT' and $TaxCode != 'NOTREPORT'">
                    <Impuestos>
                      <Traslados>
                        <xsl:choose>

                          <xsl:when test="$TaxCode = 'IVA' or $TaxCode = 'CAPIVA'">
                            <Traslado>
                              <xsl:attribute name="Impuesto">
                                <xsl:value-of select="'002'"/>
                              </xsl:attribute>
                              <xsl:attribute name="Base">
                                <xsl:value-of select="format-number($Importe, '0.00')"/>
                              </xsl:attribute>
                              <xsl:attribute name="TipoFactor">
                                <xsl:value-of select="'Tasa'"/>
                              </xsl:attribute>
                              <xsl:attribute name="TasaOCuota">
                                <xsl:value-of select="'0.160000'"/>
                              </xsl:attribute>
                              <xsl:attribute name="Importe">
                                <xsl:value-of select="format-number($valorImporteIVA, '0.00')"/>
                              </xsl:attribute>
                            </Traslado>
                          </xsl:when>

                          <xsl:when test="$TaxCode = 'IVA4'">
                            <Traslado>
                              <xsl:attribute name="Impuesto">
                                <xsl:value-of select="'002'"/>
                              </xsl:attribute>
                              <xsl:attribute name="Base">
                                <xsl:value-of select="format-number($valorBaseIVA4, '0.00')"/>
                              </xsl:attribute>
                              <xsl:attribute name="TipoFactor">
                                <xsl:value-of select="'Tasa'"/>
                              </xsl:attribute>
                              <xsl:attribute name="TasaOCuota">
                                <xsl:value-of select="'0.160000'"/>
                              </xsl:attribute>
                              <xsl:attribute name="Importe">
                                <xsl:value-of select="format-number($valorImporteIVA4, '0.00')"/>
                              </xsl:attribute>
                            </Traslado>

                            <Traslado>
                              <xsl:attribute name="Impuesto">
                                <xsl:value-of select="'002'"/>
                              </xsl:attribute>
                              <xsl:attribute name="Base">
                                <xsl:value-of select="format-number($valorBaseFREEIVA4, '0.00')"/>
                              </xsl:attribute>
                              <xsl:attribute name="TipoFactor">
                                <xsl:value-of select="'Tasa'"/>
                              </xsl:attribute>
                              <xsl:attribute name="TasaOCuota">
                                <xsl:value-of select="'0.000000'"/>
                              </xsl:attribute>
                              <xsl:attribute name="Importe">
                                <xsl:value-of select="format-number($valorImporteFREEIVA4, '0.00')"
                                />
                              </xsl:attribute>
                            </Traslado>
                          </xsl:when>

                          <xsl:when test="$TaxCode = 'FREEIVA'">
                            <Traslado>
                              <xsl:attribute name="Impuesto">
                                <xsl:value-of select="'002'"/>
                              </xsl:attribute>
                              <xsl:attribute name="Base">
                                <xsl:value-of select="format-number($valorBaseFREEIVA, '0.00')"/>
                              </xsl:attribute>
                              <xsl:attribute name="TipoFactor">
                                <xsl:value-of select="'Tasa'"/>
                              </xsl:attribute>
                              <xsl:attribute name="TasaOCuota">
                                <xsl:value-of select="'0.000000'"/>
                              </xsl:attribute>
                              <xsl:attribute name="Importe">
                                <xsl:value-of select="format-number($valorImporteFREEIVA, '0.00')"/>
                              </xsl:attribute>
                            </Traslado>
                          </xsl:when>

                          <xsl:when test="$TaxCode = 'IVARET'">
                            <Traslado>
                              <xsl:attribute name="Impuesto">
                                <xsl:value-of select="'002'"/>
                              </xsl:attribute>
                              <xsl:attribute name="Base">
                                <xsl:value-of select="format-number($valorBaseIVARET, '0.00')"/>
                              </xsl:attribute>
                              <xsl:attribute name="TipoFactor">
                                <xsl:value-of select="'Tasa'"/>
                              </xsl:attribute>
                              <xsl:attribute name="TasaOCuota">
                                <xsl:value-of select="'0.160000'"/>
                              </xsl:attribute>
                              <xsl:attribute name="Importe">
                                <xsl:value-of select="format-number($valorImporteTraIVARET, '0.00')"
                                />
                              </xsl:attribute>
                            </Traslado>
                          </xsl:when>

                        </xsl:choose>
                      </Traslados>

                      <!-- Impuestos Retenciones -->
                      <xsl:if test="$TaxCode = 'IVARET'">
                        <Retenciones>
                          <Retencion>
                            <xsl:attribute name="Impuesto">
                              <xsl:value-of select="'002'"/>
                            </xsl:attribute>
                            <xsl:attribute name="Base">
                              <xsl:value-of select="format-number($valorBaseIVARET, '0.00')"/>
                            </xsl:attribute>
                            <xsl:attribute name="TipoFactor">
                              <xsl:value-of select="'Tasa'"/>
                            </xsl:attribute>
                            <xsl:attribute name="TasaOCuota">
                              <xsl:value-of select="'0.040000'"/>
                            </xsl:attribute>
                            <xsl:attribute name="Importe">
                              <xsl:value-of select="format-number($valorImporteRetIVARET, '0.00')"/>
                            </xsl:attribute>
                          </Retencion>
                        </Retenciones>
                      </xsl:if>
                    </Impuestos>
                  </xsl:if>

                  <!--Información Adicional-->

                  <InformacionAdicional>
                    <xsl:element name="impuesto">
                      <xsl:value-of select="$TaxCode"/>
                    </xsl:element>

                    <xsl:element name="ClaveProdServ">
                      <xsl:value-of select="w:GovernmentReportingChargeCode"/>
                    </xsl:element>

                    <xsl:element name="ClaveUnidad">
                      <xsl:choose>
                        <xsl:when test="$ChargeCodeCode = 'NCDEV' or contains($GLAccount, '425.0')">
                          <xsl:value-of select="'ACT'"/>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:value-of select="'E48'"/>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:element>

                    <xsl:element name="Cantidad">
                      <xsl:value-of select="'1'"/>
                    </xsl:element>

                    <xsl:element name="categoria">
                      <xsl:value-of
                        select="concat($departamentoCode, ' - ', $departamentoName, ' - ', $ChargeCodeCode)"
                      />
                    </xsl:element>

                    <xsl:element name="Descripcion">
                      <xsl:value-of select="translate(w:Description, '|', '')"/>
                    </xsl:element>

                    <xsl:element name="ValorUnitario">
                      <xsl:value-of select="format-number($Importe, '#,##0.00')"/>
                    </xsl:element>

                    <xsl:element name="Importe">
                      <xsl:value-of select="format-number($Importe, '#,##0.00')"/>
                    </xsl:element>

                    <xsl:element name="Base">
                      <xsl:choose>
                        <xsl:when test="$TaxCode = 'IVA4'">
                          <xsl:value-of select="format-number($Importe div 4, '#,##0.00')"/>
                        </xsl:when>
                        <xsl:when test="$TaxCode = 'IVA'">
                          <xsl:value-of select="format-number($Importe, '#,##0.00')"/>
                        </xsl:when>
                        <xsl:when test="$TaxCode = 'IVARET'">
                          <xsl:value-of select="format-number($Importe, '#,##0.00')"/>
                        </xsl:when>
                        <xsl:when test="$TaxCode = 'FREEIVA'">
                          <xsl:value-of select="format-number($Importe, '#,##0.00')"/>
                        </xsl:when>
                        <xsl:when test="$TaxCode = 'EXEMPT'">
                          <xsl:value-of select="format-number($Importe, '#,##0.00')"/>
                        </xsl:when>
                      </xsl:choose>
                    </xsl:element>

                    <xsl:element name="job">
                      <xsl:value-of select="w:Job/w:Key"/>
                    </xsl:element>
                    <xsl:element name="house">
                      <xsl:value-of select="$house"/>
                    </xsl:element>
                    <xsl:element name="origin">
                      <xsl:value-of select="$origin"/>
                    </xsl:element>
                    <xsl:element name="destination">
                      <xsl:value-of select="$destination"/>
                    </xsl:element>
                    <xsl:element name="consignor">
                      <xsl:value-of select="$consignor"/>
                    </xsl:element>
                    <xsl:element name="consignee">
                      <xsl:value-of select="$consignee"/>
                    </xsl:element>
                    <xsl:element name="tipoImpuesto">
                      <xsl:choose>
                        <xsl:when test="$TaxCode = 'IVA4'">
                          <xsl:value-of select="'IVA 16% al 25%'"/>
                        </xsl:when>
                        <xsl:when test="$TaxCode = 'IVA'">
                          <xsl:value-of select="'IVA 16%'"/>
                        </xsl:when>
                        <xsl:when test="$TaxCode = 'IVARET'">
                          <xsl:value-of select="'IVA 16% - RET 4%'"/>
                        </xsl:when>
                        <xsl:when test="$TaxCode = 'FREEIVA'">
                          <xsl:value-of select="'IVA 0%'"/>
                        </xsl:when>
                        <xsl:when test="$TaxCode = 'EXEMPT'">
                          <xsl:value-of select="'EXENTO'"/>
                        </xsl:when>
                        <xsl:otherwise>
                          <xsl:value-of select="$TaxCode"/>
                        </xsl:otherwise>
                      </xsl:choose>
                    </xsl:element>
                    <xsl:element name="importeImpuesto">
                      <xsl:value-of select="format-number($ImporteTransferido, '#,##0.00')"/>
                    </xsl:element>

                    <xsl:element name="importeTotal">
                      <xsl:value-of
                        select="format-number($Importe + $ImporteTransferido, '#,##0.00')"/>
                    </xsl:element>

                    <xsl:element name="containers">
                      <xsl:value-of
                        select="substring($containers, 0, string-length($containers) - 1)"/>
                    </xsl:element>
                    <xsl:element name="goodsDescription">
                      <xsl:value-of select="$GoodsDescription"/>
                    </xsl:element>
                    <xsl:element name="OrderRef">
                      <xsl:value-of select="substring($OrderRef, 0, string-length($OrderRef) - 1)"/>
                    </xsl:element>
                  </InformacionAdicional>
                </Concepto>

              </xsl:if>
            </xsl:for-each>
          </Conceptos>
        </xsl:otherwise>
      </xsl:choose>

      <xsl:variable name="exempt">
        <xsl:for-each select="//w:PostingJournalCollection/w:PostingJournal">

          <xsl:variable name="job" select="w:Job/w:Key"/>

          <xsl:variable name="origin"
            select="concat(//w:ShipmentCollection/w:Shipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:PortOfLoading/w:Code, ' / ', //w:ShipmentCollection/w:Shipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $job]/w:PortOfLoading/w:Name)"/>

          <xsl:variable name="TaxCode" select="w:VATTaxID/w:TaxCode"/>

          <xsl:value-of select="concat('-', $TaxCode)"/>
        </xsl:for-each>
      </xsl:variable>

      <xsl:if test="contains($exempt, 'IVA')">
        <Impuestos>
          <xsl:variable name="pathImp"
            select="//w:PostingJournalCollection/w:PostingJournal[w:ChargeCode/w:Code != 'DTA' and w:ChargeCode/w:Code != 'PREVAL' and w:ChargeCode/w:Code != 'CMT']"/>
          <xsl:if test="number($IVASuma) >= 0">
            <xsl:attribute name="TotalImpuestosTrasladados">
              <xsl:value-of select="format-number($IVASuma, '0.00')"/>
            </xsl:attribute>
          </xsl:if>

          <xsl:if test="$IVARetenidoSuma > 0">
            <xsl:attribute name="TotalImpuestosRetenidos">
              <xsl:value-of select="format-number($IVARetenidoSuma, '0.00')"/>
            </xsl:attribute>
          </xsl:if>

          <xsl:if test="$IVARetenidoSuma > 0">
            <Retenciones>
              <Retencion>
                <xsl:attribute name="Impuesto">
                  <xsl:value-of select="'002'"/>
                </xsl:attribute>
                <xsl:attribute name="Importe">
                  <xsl:value-of select="format-number($IVARetenidoSuma, '0.00')"/>
                </xsl:attribute>
              </Retencion>
            </Retenciones>
          </xsl:if>

          <Traslados>
            <xsl:if test="$IVASuma > 0">
              <xsl:if test="contains($exempt, 'IVA') or contains($exempt, 'IVARET')">
                <xsl:variable name="BaseSumIVA">
                  <xsl:choose>
                    <xsl:when
                      test="number(//w:PostingJournalCollection/w:PostingJournal[w:VATTaxID/w:TaxCode = 'IVA']/w:OSAmount) &lt; 0">
                      <xsl:value-of
                        select="(sum(//w:PostingJournalCollection/w:PostingJournal[w:VATTaxID/w:TaxCode = 'IVA']/w:OSAmount)) * -1"
                      />
                    </xsl:when>
                    <xsl:when
                      test="//w:PostingJournalCollection/w:PostingJournal[w:VATTaxID/w:TaxCode = 'IVA']/w:OSAmount">
                      <xsl:value-of
                        select="(sum(//w:PostingJournalCollection/w:PostingJournal[w:VATTaxID/w:TaxCode = 'IVA']/w:OSAmount))"
                      />
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:value-of select="0"/>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:variable>
                <xsl:variable name="BaseSumCAPIVA">
                  <xsl:choose>
                    <xsl:when
                      test="number(//w:PostingJournalCollection/w:PostingJournal[w:VATTaxID/w:TaxCode = 'CAPIVA']/w:OSAmount) &lt; 0">
                      <xsl:value-of
                        select="(sum(//w:PostingJournalCollection/w:PostingJournal[w:VATTaxID/w:TaxCode = 'CAPIVA']/w:OSAmount)) * -1"
                      />
                    </xsl:when>
                    <xsl:when
                      test="//w:PostingJournalCollection/w:PostingJournal[w:VATTaxID/w:TaxCode = 'CAPIVA']/w:OSAmount">
                      <xsl:value-of
                        select="(sum(//w:PostingJournalCollection/w:PostingJournal[w:VATTaxID/w:TaxCode = 'CAPIVA']/w:OSAmount))"
                      />
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:value-of select="0"/>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:variable>
                <xsl:variable name="BaseSumIVARET">
                  <xsl:choose>
                    <xsl:when
                      test="number(//w:PostingJournalCollection/w:PostingJournal[w:VATTaxID/w:TaxCode = 'IVARET']/w:OSAmount) &lt; 0">
                      <xsl:value-of
                        select="number(sum(//w:PostingJournalCollection/w:PostingJournal[w:VATTaxID/w:TaxCode = 'IVARET']/w:OSAmount)) * -1"
                      />
                    </xsl:when>
                    <xsl:when
                      test="//w:PostingJournalCollection/w:PostingJournal[w:VATTaxID/w:TaxCode = 'IVARET']/w:OSAmount">
                      <xsl:value-of
                        select="number(sum(//w:PostingJournalCollection/w:PostingJournal[w:VATTaxID/w:TaxCode = 'IVARET']/w:OSAmount))"
                      />
                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:value-of select="0"/>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:variable>
                <xsl:variable name="BaseSumIVA4">
                  <xsl:choose>
                    <xsl:when
                      test="number(//w:PostingJournalCollection/w:PostingJournal[w:VATTaxID/w:TaxCode = 'IVA4']/w:OSAmount) &lt; 0">

                      <xsl:variable name="rounded-amounts">
                        <xsl:for-each
                          select="//w:PostingJournalCollection/w:PostingJournal[w:VATTaxID/w:TaxCode = 'IVA4']">
                          <amt>
                            <xsl:value-of select="round(w:OSAmount * -1 div 4 * 100) div 100"/>
                          </amt>
                        </xsl:for-each>
                      </xsl:variable>

                      <xsl:value-of select="sum(exsl:node-set($rounded-amounts)/amt)"/>

                    </xsl:when>

                    <xsl:when
                      test="//w:PostingJournalCollection/w:PostingJournal[w:VATTaxID/w:TaxCode = 'IVA4']/w:OSAmount">

                      <xsl:variable name="rounded-amounts">
                        <xsl:for-each
                          select="//w:PostingJournalCollection/w:PostingJournal[w:VATTaxID/w:TaxCode = 'IVA4']">
                          <amt>
                            <xsl:value-of select="round(w:OSAmount div 4 * 100) div 100"/>
                          </amt>
                        </xsl:for-each>
                      </xsl:variable>

                      <xsl:value-of select="sum(exsl:node-set($rounded-amounts)/amt)"/>

                    </xsl:when>
                    <xsl:otherwise>
                      <xsl:value-of select="0"/>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:variable>

                <Traslado>
                  <xsl:attribute name="Base">
                    <xsl:value-of
                      select="format-number(round(number($BaseSumIVARET + $BaseSumIVA + $BaseSumCAPIVA + $BaseSumIVA4) * 100) div 100, '0.00')"
                    />
                  </xsl:attribute>

                  <xsl:attribute name="Impuesto">
                    <xsl:value-of select="'002'"/>
                  </xsl:attribute>

                  <xsl:attribute name="Importe">
                    <xsl:value-of select="format-number($IVASuma, '0.00')"/>
                  </xsl:attribute>

                  <xsl:attribute name="TasaOCuota">
                    <xsl:value-of select="'0.160000'"/>
                  </xsl:attribute>

                  <xsl:attribute name="TipoFactor">
                    <xsl:value-of select="'Tasa'"/>
                  </xsl:attribute>

                </Traslado>
              </xsl:if>
            </xsl:if>

            <!-- use variables in the XPath expression -->
            <xsl:if test="contains($exempt, 'FREE') or contains($exempt, '4')">
              <xsl:variable name="BaseSumFREEIVA">
                <xsl:value-of
                  select="sum($pathImp[w:VATTaxID/w:TaxCode = 'FREEIVA']/w:OSAmount[not(. = 'NaN')]/abs(.))"
                />
              </xsl:variable>
              <xsl:variable name="BaseSumEXEMPT">
                <xsl:value-of
                  select="sum($pathImp[w:VATTaxID/w:TaxCode = 'EXEMPT']/w:OSAmount[not(. = 'NaN')]/abs(.))"
                />
              </xsl:variable>
              <xsl:variable name="BaseSumIVA4">
                <xsl:choose>
                  <xsl:when
                    test="number(//w:PostingJournalCollection/w:PostingJournal[w:VATTaxID/w:TaxCode = 'IVA4']/w:OSAmount) &lt; 0">

                    <xsl:variable name="rounded-amounts">
                      <xsl:for-each
                        select="//w:PostingJournalCollection/w:PostingJournal[w:VATTaxID/w:TaxCode = 'IVA4']">
                        <amt>
                          <xsl:value-of select="round(w:OSAmount * -1 div 4 * 3 * 100) div 100"/>
                        </amt>
                      </xsl:for-each>
                    </xsl:variable>

                    <xsl:value-of select="sum(exsl:node-set($rounded-amounts)/amt)"/>

                  </xsl:when>

                  <xsl:when
                    test="//w:PostingJournalCollection/w:PostingJournal[w:VATTaxID/w:TaxCode = 'IVA4']/w:OSAmount">

                    <xsl:variable name="rounded-amounts">
                      <xsl:for-each
                        select="//w:PostingJournalCollection/w:PostingJournal[w:VATTaxID/w:TaxCode = 'IVA4']">
                        <amt>
                          <xsl:value-of select="round(w:OSAmount div 4 * 3 * 100) div 100"/>
                        </amt>
                      </xsl:for-each>
                    </xsl:variable>

                    <xsl:value-of select="sum(exsl:node-set($rounded-amounts)/amt)"/>

                  </xsl:when>
                  <xsl:otherwise>
                    <xsl:value-of select="0"/>
                  </xsl:otherwise>
                </xsl:choose>
              </xsl:variable>

              <Traslado>
                <!--<xsl:attribute name="BaseSumFREEIVA">
                  <xsl:value-of select="$BaseSumFREEIVA"/>
                </xsl:attribute>
                <xsl:attribute name="BaseSumEXEMPT">
                  <xsl:value-of select="$BaseSumEXEMPT"/>
                </xsl:attribute>
                <xsl:attribute name="BaseSumIVA4">
                  <xsl:value-of select="$BaseSumIVA4"/>
                </xsl:attribute>-->

                <xsl:attribute name="Base">
                  <xsl:value-of
                    select="format-number(round(number($BaseSumFREEIVA + $BaseSumEXEMPT + $BaseSumIVA4) * 100) div 100, '0.00')"
                  />
                </xsl:attribute>

                <xsl:attribute name="Impuesto">
                  <xsl:value-of select="'002'"/>
                </xsl:attribute>

                <xsl:attribute name="Importe">
                  <xsl:value-of select="'0.00'"/>
                </xsl:attribute>

                <xsl:attribute name="TasaOCuota">
                  <xsl:value-of select="'0.000000'"/>
                </xsl:attribute>

                <xsl:attribute name="TipoFactor">
                  <xsl:value-of select="'Tasa'"/>
                </xsl:attribute>
              </Traslado>
            </xsl:if>

          </Traslados>

        </Impuestos>
      </xsl:if>

      <!-- Tipp de Documento Stellantis -->
      <xsl:variable name="tdoc">
        <xsl:choose>
          <xsl:when test="//w:TransactionInfo/w:TransactionType = 'INV'">

            <xsl:value-of select="'FA'"/>

          </xsl:when>
          <xsl:when test="//w:TransactionInfo/w:TransactionType = 'CRD'">

            <xsl:value-of select="'CR'"/>

          </xsl:when>
        </xsl:choose>
      </xsl:variable>

      <!--Addenda STELLANTIS-->
      <xsl:if test="$rfc = 'CME720930GM9'">
        <Addenda>
          <TOB:factura xmlns:TOB="http://www.dfdchryslerdemexico.com.mx/Addenda/TOB"
            xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" tipoDocumento="TOB"
            TipoDocumentoFiscal="{$tdoc}" version="1.0" folioFiscal="{concat($serie, '-', $folio)}"
            fecha="{$fechaemision}" montoTotal="{format-number($total, '0.00')}"
            referenciaProveedor="44639"
            xsi:schemaLocation="http://www.dfdchryslerdemexico.com.mx/Addenda/TOB http://www.dfdchryslerdemexico.com.mx/Addenda/TOB/TOB.XSD">
            <TOB:moneda tipoMoneda="{$Moneda}" tipoCambio="{$TipoCambio}"/>
            <TOB:proveedor codigo="44639" nombre="KENSA LOGISTICS MEXICO"/>
            <TOB:destino
              codigo="{//w:ShipmentCollection/w:Shipment/w:ContainerCollection/w:Container/w:AdditionalServiceCollection/w:AdditionalService/w:ServiceNote}"
              nombre="{//w:PostingJournalCollection/w:PostingJournal[w:ChargeCode/w:Code = 'FREETEXT']/w:Description}"/>
            <TOB:otrosCargos codigo="V5" monto="{format-number($total - $subTotal2, '0.00')}"/>
          </TOB:factura>
        </Addenda>
      </xsl:if>

      <Especiales>
        <Header>

          <xsl:attribute name="Impuestos">
            <xsl:value-of select="$exempt"/>
          </xsl:attribute>

          <xsl:attribute name="ResidenciaFiscal">
            <xsl:value-of select="//w:TransactionInfo/w:OrganizationAddress/w:Country/w:Name"/>
          </xsl:attribute>

          <xsl:attribute name="ReferenciaCliente">
            <xsl:variable name="shp" select="//w:TransactionInfo/w:Description"/>
            <xsl:for-each
              select="//w:ShipmentCollection/w:Shipment[w:DataContext/w:DataSourceCollection/w:DataSource[w:Type = 'ForwardingShipment']/w:Key = $shp]//w:LocalProcessing/w:OrderNumberCollection/w:OrderNumber">
              <xsl:value-of select="concat(w:OrderReference, ' ')"/>
            </xsl:for-each>
          </xsl:attribute>

          <!-- Variable Periodic Invoice -->
          <xsl:variable name="PI">

            <xsl:value-of select="//w:TransactionInfo/w:Description"/>

          </xsl:variable>

          <xsl:attribute name="PINV">
            <xsl:value-of select="$PI = 'AR PERIODIC INVOICE'"/>
          </xsl:attribute>


          <xsl:choose>
            <!-- Verifica si el valor de Description es igual a "AR PERIODIC INVOICE" -->
            <xsl:when test="$PI = 'AR PERIODIC INVOICE'">
              <!-- Si es igual, asigna el valor de SHP2 -->
              <xsl:attribute name="shp">
                <xsl:for-each
                  select="//w:PostingJournalCollection/w:PostingJournal/w:Job[generate-id() = generate-id(key('uniqueJobs', w:Key)[1])]">
                  <xsl:value-of select="w:Key"/>
                  <xsl:if test="position() != last()">, </xsl:if>
                </xsl:for-each>
              </xsl:attribute>
            </xsl:when>

            <!-- Si no es igual, deja el valor original de Description -->
            <xsl:otherwise>
              <xsl:attribute name="shp">
                <xsl:value-of select="//w:TransactionInfo/w:Description"/>
              </xsl:attribute>
            </xsl:otherwise>
          </xsl:choose>


          <xsl:attribute name="Containers">
            <xsl:for-each select="
                //w:SubShipmentCollection/w:SubShipment/w:ContainerCollection/w:Container[
                generate-id() = generate-id(key('uniqueContainers', w:ContainerNumber)[1])
                ]">
              <xsl:value-of select="concat(w:ContainerNumber, ' ')"/>
            </xsl:for-each>
          </xsl:attribute>


          <!--
		 <xsl:variable name="uniqueContainers">
  <xsl:for-each select="//w:SubShipmentCollection/w:SubShipment/w:ContainerCollection/w:Container">
    <xsl:if test="not(. = preceding::w:ContainerNumber)">
      <xsl:value-of select="concat(w:ContainerNumber, ' ')"/>
    </xsl:if>
  </xsl:for-each>
</xsl:variable>

<xsl:attribute name="Containers">
  <xsl:value-of select="$uniqueContainers"/>
</xsl:attribute>
-->



          <xsl:attribute name="Servicio">
            <xsl:for-each select="//w:ShipmentCollection/w:Shipment">
              <xsl:variable name="currentCode" select="w:ContainerMode/w:Code"/>
              <xsl:if
                test="generate-id($currentCode) = generate-id(key('ServicioKey', $currentCode)[1])">
                <xsl:value-of select="$currentCode"/>
              </xsl:if>
            </xsl:for-each>
          </xsl:attribute>

          <xsl:if test="//w:TransactionInfo/w:OrganizationAddress/w:OrganizationCode">
            <xsl:attribute name="CustomerID">
              <xsl:value-of select="//w:TransactionInfo/w:OrganizationAddress/w:OrganizationCode"/>
            </xsl:attribute>
          </xsl:if>
          <xsl:if test="//w:TransactionInfo/w:Job/w:Key">
            <xsl:attribute name="Shipment">
              <xsl:value-of select="//w:TransactionInfo/w:Job/w:Key"/>
            </xsl:attribute>
          </xsl:if>
          <xsl:if test="//w:TransactionInfo/w:DataContext/w:EventUser/w:Name">
            <xsl:attribute name="PrintedBy">
              <xsl:value-of select="//w:TransactionInfo/w:DataContext/w:EventUser/w:Name"/>
            </xsl:attribute>
          </xsl:if>
          <xsl:if test="//w:TransactionInfo/w:DataContext/w:EventBranch/w:Name">
            <xsl:attribute name="Office">
              <xsl:value-of select="//w:TransactionInfo/w:DataContext/w:EventBranch/w:Name"/>
            </xsl:attribute>
          </xsl:if>
          <xsl:for-each select="//w:OrganizationAddress">
            <xsl:variable name="AdressType" select="w:AddressType"/>
            <xsl:if test="$AdressType = 'ConsignorDocumentaryAddress'">
              <xsl:attribute name="Shipper">
                <xsl:value-of select="w:CompanyName"/>
              </xsl:attribute>
            </xsl:if>
            <xsl:if test="$AdressType = 'ConsigneeDocumentaryAddress'">
              <xsl:attribute name="Consignee">
                <xsl:value-of select="w:CompanyName"/>
              </xsl:attribute>
            </xsl:if>
          </xsl:for-each>
          <!--<xsl:variable name="GoodsDescription"><xsl:for-each select="//w:RateLineCollection/w:RateLine/w:GoodsDescription"><xsl:if test=".[not(. = preceding::*)]"><xsl:value-of select="concat(., ', ')"/></xsl:if></xsl:for-each></xsl:variable>-->
          <xsl:attribute name="GoodsDescription">
            <xsl:value-of
              select="//w:Shipment/w:CarrierDocumentsOverride/w:AWBHeader/w:RateLineCollection/w:RateLine/w:GoodsDescription"
            />
          </xsl:attribute>





          <xsl:choose>
            <!-- Verifica si el valor de PI es igual a "AR PERIODIC INVOICE" -->
            <xsl:when test="$PI = 'AR PERIODIC INVOICE'">
              <!-- Calcular la suma total de PackagesCant evitando duplicados -->
              <xsl:variable name="totalSum"
                select="sum(//w:OuterPacks[generate-id() = generate-id(key('uniquePackagesCant', .)[1])])"/>

              <!-- Iterar sobre cada SubShipment -->
              <xsl:for-each select="//w:SubShipment">
                <xsl:variable name="PackagesCant" select="w:OuterPacks"/>

                <!-- Solo mostrar la suma una vez (en la primera iteración) -->
                <xsl:if test="position() = 1">
                  <xsl:attribute name="Packages">
                    <xsl:value-of select="$totalSum"/>
                  </xsl:attribute>
                </xsl:if>
              </xsl:for-each>
            </xsl:when>

            <!-- Si la condición no se cumple, usar la lógica original -->
            <xsl:otherwise>
              <xsl:for-each select="//w:SubShipment">
                <xsl:variable name="PackagesCant" select="w:OuterPacks"/>
                <xsl:variable name="PackagesType" select="w:OuterPacksPackageType/w:Code"/>
                <xsl:attribute name="Packages">
                  <xsl:value-of select="concat($PackagesCant, ' ', $PackagesType)"/>
                </xsl:attribute>
              </xsl:for-each>
            </xsl:otherwise>
          </xsl:choose>




          <xsl:for-each select="//w:ShipmentCollection/w:Shipment">
            <xsl:variable name="TotalWeight"
              select="w:SubShipmentCollection/w:SubShipment/w:ManifestedWeight"/>
            <xsl:variable name="TotalWeightUnit" select="w:TotalWeightUnit/w:Code"/>
            <xsl:attribute name="Weight">
              <xsl:value-of select="concat($TotalWeight, ' ', $TotalWeightUnit)"/>
            </xsl:attribute>
            <xsl:variable name="TotalVolume"
              select="w:SubShipmentCollection/w:SubShipment/w:ManifestedVolume"/>
            <xsl:variable name="TotalVolumeUnit" select="w:TotalVolumeUnit/w:Code"/>
            <xsl:attribute name="Volume">
              <xsl:value-of select="concat($TotalVolume, ' ', $TotalVolumeUnit)"/>
            </xsl:attribute>
            <xsl:variable name="DocumentedChargeable" select="w:DocumentedChargeable"/>
            <xsl:attribute name="Chargeable">
              <xsl:value-of select="concat($DocumentedChargeable, ' ', $TotalWeightUnit)"/>
            </xsl:attribute>
            <xsl:variable name="VesselName" select="concat(w:VesselName, ' / ')"/>
            <xsl:variable name="VoyageFlightNo" select="concat(w:VoyageFlightNo, ' / ')"/>
            <xsl:variable name="LloydsIMO" select="w:LloydsIMO"/>
            <xsl:variable name="VesVoyLlo" select="concat($VesselName, $VoyageFlightNo, $LloydsIMO)"/>
            <xsl:attribute name="Vessel">
              <xsl:value-of select="$VesVoyLlo"/>
            </xsl:attribute>

            <xsl:variable name="MAWB">
              <xsl:for-each select="//w:TransactionInfo/w:ShipmentCollection/w:Shipment">
                <xsl:variable name="currentWayBillNumber" select="w:WayBillNumber"/>
                <xsl:if
                  test="w:WayBillType/w:Code = 'MWB' and generate-id($currentWayBillNumber) = generate-id(key('MAWBKey', $currentWayBillNumber)[1])">
                  <xsl:value-of select="concat($currentWayBillNumber, ', ')"/>
                </xsl:if>
              </xsl:for-each>
            </xsl:variable>

            <!--<xsl:variable name="MAWB">
              <xsl:for-each select="//w:TransactionInfo/w:ShipmentCollection/w:Shipment">
                <xsl:variable name="TipoMAWB">
                  <xsl:value-of select="w:WayBillType/w:Code"/>
                </xsl:variable>
                <xsl:if test="$TipoMAWB = 'MWB'">
                  <xsl:value-of select="w:WayBillNumber"/>
                </xsl:if>
              </xsl:for-each>
            </xsl:variable>-->




            <xsl:attribute name="MAWB">
              <xsl:value-of select="$MAWB"/>
            </xsl:attribute>

            <xsl:variable name="HAWB">
              <xsl:for-each select="//w:SubShipmentCollection/w:SubShipment">
                <xsl:variable name="currentWayBillNumber" select="w:WayBillNumber"/>
                <xsl:if
                  test="w:WayBillType/w:Code = 'HWB' and generate-id($currentWayBillNumber) = generate-id(key('HAWBKey', $currentWayBillNumber)[1])">
                  <xsl:value-of select="concat($currentWayBillNumber, ', ')"/>
                </xsl:if>
              </xsl:for-each>
            </xsl:variable>

            <!--<xsl:variable name="HAWB">
              <xsl:for-each select="//w:SubShipmentCollection/w:SubShipment">
                <xsl:variable name="TipoHAWB">
                  <xsl:value-of select="w:WayBillType/w:Code"/>
                </xsl:variable>
                <xsl:if test="$TipoHAWB = 'HWB'">
                  <xsl:value-of select="w:WayBillNumber"/>
                </xsl:if>
              </xsl:for-each>
            </xsl:variable>-->



            <xsl:attribute name="HAWB">
              <xsl:value-of select="$HAWB"/>
            </xsl:attribute>




            <xsl:variable name="HouseBillOfLanding">
              <xsl:value-of select="..//w:Shipment/w:WayBillNumber"/>
            </xsl:variable>
            <xsl:choose>
              <!-- Verifica si el valor de Description es igual a "AR PERIODIC INVOICE" -->
              <xsl:when test="//w:TransactionInfo/w:Description = 'AR PERIODIC INVOICE'">
                <!-- Si es igual, asigna el valor de HouseBillOfLanding -->
                <xsl:attribute name="HouseBillOfLanding">

                  <xsl:for-each
                    select="//w:Shipment/w:WayBillNumber[generate-id() = generate-id(key('uniqueWayBillNumbers', .)[1])]">
                    <xsl:value-of select="."/>
                    <xsl:if test="position() != last()">, </xsl:if>
                  </xsl:for-each>

                </xsl:attribute>
              </xsl:when>

              <!-- Si no es igual, deja el valor original de Description -->
              <xsl:otherwise>
                <xsl:attribute name="HouseBillOfLanding">
                  <xsl:value-of
                    select="translate(translate($HouseBillOfLanding, '&#xA;', ' '), ' ', '')"/>
                </xsl:attribute>
              </xsl:otherwise>
            </xsl:choose>




            <xsl:attribute name="Origin">
              <xsl:value-of select="concat(w:PortOfLoading/w:Name, ' - ', w:PortOfLoading/w:Code)"/>
            </xsl:attribute>
            <xsl:attribute name="Destination">
              <xsl:value-of
                select="concat(w:PortOfDischarge/w:Name, ' - ', w:PortOfDischarge/w:Code)"/>
            </xsl:attribute>
            <xsl:variable name="ETD">
              <xsl:value-of select="..//w:DateCollection/w:Date[w:Type = 'Departure']/w:Value"/>
            </xsl:variable>
            <xsl:attribute name="ETD">
              <xsl:value-of select="$ETD"/>
            </xsl:attribute>
            <xsl:variable name="ETA">
              <xsl:value-of select="..//w:DateCollection/w:Date[w:Type = 'Arrival']/w:Value"/>
            </xsl:variable>
            <xsl:attribute name="ETA">
              <xsl:value-of select="$ETA"/>
            </xsl:attribute>
          </xsl:for-each>

          <xsl:choose>
            <!-- Verifica si la condición es la que deseas (ajusta según tu necesidad) -->
            <xsl:when test="$PI = 'AR PERIODIC INVOICE'">
              <!-- Calcular la suma total de Weight evitando duplicados -->
              <xsl:variable name="totalWeightSum"
                select="sum(//w:SubShipmentCollection/w:SubShipment/w:ManifestedWeight[generate-id() = generate-id(key('uniqueWeights', .)[1])])"/>

              <!-- Iterar sobre cada Shipment -->
              <xsl:for-each select="//w:ShipmentCollection/w:Shipment">
                <xsl:variable name="TotalWeightUnit" select="w:TotalWeightUnit/w:Code"/>

                <!-- Solo mostrar la suma una vez (en la primera iteración) -->
                <xsl:if test="position() = 1">
                  <xsl:attribute name="Weight">
                    <xsl:value-of select="concat($totalWeightSum, ' ', $TotalWeightUnit)"/>
                  </xsl:attribute>
                </xsl:if>
              </xsl:for-each>
            </xsl:when>


          </xsl:choose>

          <xsl:attribute name="PayRef">
            <xsl:value-of select="//w:TransactionInfo/w:Number"/>
          </xsl:attribute>
          <xsl:choose>
            <xsl:when test="//w:TransactionInfo/w:TransactionType = 'INV'">
              <xsl:attribute name="TipoDocumento">
                <xsl:value-of select="'Invoice ID'"/>
              </xsl:attribute>
            </xsl:when>
            <xsl:when test="//w:TransactionInfo/w:TransactionType = 'CRD'">
              <xsl:attribute name="TipoDocumento">
                <xsl:value-of select="'Credit Note ID'"/>
              </xsl:attribute>
            </xsl:when>
          </xsl:choose>
          <!--
          Se definen los valores de la suma de los DTA, PREVAL y se crea el Grand Total
          -->
          <xsl:variable name="DTA"
            select="sum(//w:PostingJournal[w:ChargeCode/w:Code = 'DTA']/w:OSAmount)"/>
          <xsl:variable name="PREVAL"
            select="sum(//w:PostingJournal[w:ChargeCode/w:Code = 'PREVAL']/w:OSAmount)"/>
          <xsl:attribute name="DTA">
            <xsl:value-of select="format-number($DTA, '0.00')"/>
          </xsl:attribute>
          <xsl:attribute name="PREVAL">
            <xsl:value-of select="format-number($PREVAL, '0.00')"/>
          </xsl:attribute>
          <xsl:attribute name="GrandTotal">
            <xsl:value-of select="format-number($total + $PREVAL + $DTA, '0.00')"/>
          </xsl:attribute>
        </Header>
      </Especiales>
      <Moneda>
        <xsl:attribute name="tipo">
          <xsl:value-of select="//w:TransactionInfo/w:OSCurrency/w:Code"/>
        </xsl:attribute>
        <xsl:attribute name="cambio">
          <xsl:variable name="TotalPesos" select="number(//w:TransactionInfo/w:LocalTotal)"/>
          <xsl:variable name="TotalDolares">
            <xsl:value-of select="number(//w:TransactionInfo/w:OSTotal)"/>
          </xsl:variable>
          <xsl:choose>
            <xsl:when test="format-number($TotalPesos div $TotalDolares, '0.0000') = 'NaN'">
              <xsl:value-of select="'1.0000'"/>
            </xsl:when>
            <xsl:otherwise>
              <xsl:value-of select="format-number($TotalPesos div $TotalDolares, '0.0000')"/>
            </xsl:otherwise>
          </xsl:choose>
        </xsl:attribute>
      </Moneda>
    </a:Comprobante>
  </xsl:template>
</xsl:stylesheet>
